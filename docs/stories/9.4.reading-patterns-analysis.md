# Story 9.4: Reading Comparison & Pattern Analysis (VIP)

## Status
**Ready for Review**

## Story
**As a** VIP user, **I want** to see patterns in my readings over time, **so that** I understand recurring themes in my life.

## Acceptance Criteria
1. Patterns dashboard in profile (/profile/patterns) - VIP ✅
2. Most common cards: show frequently appearing cards ✅
3. Recurring themes: identify patterns (love, career, etc.) ✅
4. Card distribution visualization: charts/graphs ✅
5. Timeline view: see reading frequency over time ✅
6. Compare 2 readings side-by-side ✅
7. Insights: "The Fool appears often in your readings" ✅
8. Export patterns report (PDF) - Deferred (existing PDF export covers readings)
9. VIP tier exclusive ✅
10. Analytics: patterns viewed ✅

## Tasks / Subtasks
- [x] **Task 1: Patterns Page**
  - [x] /profile/patterns/page.tsx
  - [x] VIP check
- [x] **Task 2: Pattern Analysis**
  - [x] Query user readings
  - [x] Calculate frequencies
  - [x] Identify themes
- [x] **Task 3: Visualizations**
  - [x] Charts library (recharts)
  - [x] Card distribution bar chart
  - [x] Theme pie chart
  - [x] Timeline graph
  - [x] Day pattern chart
  - [x] Spread usage chart
- [x] **Task 4: Comparison View**
  - [x] Side-by-side reading comparison
  - [x] Common cards detection
- [x] **Task 5: Testing**
  - [x] 32 unit tests for pattern algorithms

## Dev Notes
**Data Analysis:** Requires minimum 10 readings for analysis
**Visualizations:** Using Recharts library
**VIP Value:** Unique insights feature

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Completion Notes
- Installed Recharts for data visualization
- Created pattern analysis service with card frequency, theme detection, time patterns, spread usage
- Created 5 chart components: CardFrequencyChart, ThemeDistributionChart, TimelineChart, DayPatternChart, SpreadUsageChart
- Added personalized insights generator
- Created VIP-gated patterns page with loading, error, and insufficient data states
- Created comparison page for side-by-side reading comparison
- Added analytics events for pattern_analysis_viewed, pattern_insight_viewed, reading_comparison_viewed
- 32 unit tests covering all pattern analysis algorithms
- AC #8 (Export patterns PDF) deferred as existing PDF export covers individual readings

### File List
**New Files:**
- apps/web/src/lib/patterns/types.ts
- apps/web/src/lib/patterns/analyzer.ts
- apps/web/src/lib/patterns/index.ts
- apps/web/src/app/api/patterns/analyze/route.ts
- apps/web/src/app/api/patterns/compare/route.ts
- apps/web/src/app/profile/patterns/page.tsx
- apps/web/src/app/profile/patterns/compare/page.tsx
- apps/web/src/components/patterns/CardFrequencyChart.tsx
- apps/web/src/components/patterns/ThemeDistributionChart.tsx
- apps/web/src/components/patterns/TimelineChart.tsx
- apps/web/src/components/patterns/SpreadUsageChart.tsx
- apps/web/src/components/patterns/InsightCard.tsx
- apps/web/src/components/patterns/ReadingComparison.tsx
- apps/web/src/components/patterns/index.ts
- apps/web/tests/unit/pattern-analysis.test.ts

**Modified Files:**
- apps/web/package.json (added recharts)
- apps/web/src/lib/analytics/events.ts (added pattern events)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Phase 4 story | Sarah (PO) |
| 2026-01-18 | 1.1 | Implementation complete | James (Dev) |

