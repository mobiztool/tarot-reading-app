# Story 5.9: Admin User Management

## Status: ✅ Complete

## Story

- **As an** admin
- **I want** to view a list of all registered users
- **So that** I can monitor user growth and manage the user base

## Acceptance Criteria (ACs)

### AC 5.9.1: Users List Page ✅
- [x] Create `/admin/users` page
- [x] Display all registered users in a table
- [x] Show user email, registration date, email verification status, last login, and role
- [x] Implement search functionality to filter by email
- [x] Implement sortable columns (email, registration date, last login)
- [x] Show summary statistics (total users, verified, pending, admin count)

### AC 5.9.2: Admin Access Control ✅
- [x] Only admin users can access the page
- [x] Non-admin users redirected to home
- [x] Guest users redirected to login
- [x] Add RLS policy for admin to view all users in public.users table

### AC 5.9.3: Data Sources ✅
- [x] Support fetching from auth.users via Service Role Key (preferred)
- [x] Fallback to public.users table if Service Role Key not configured
- [x] Sync mechanism from auth.users to public.users

### AC 5.9.4: UI/UX ✅
- [x] Thai language interface
- [x] Dark theme consistent with admin dashboard
- [x] Responsive design
- [x] Loading states
- [x] Error handling with retry option
- [x] Link to Analytics dashboard

## Technical Implementation

### Files Created

1. **Page Component**
   - `apps/web/src/app/admin/users/page.tsx`

2. **API Route**
   - `apps/web/src/app/api/admin/users/route.ts`

3. **Database**
   - Added RLS policy: "Admin can view all users"

### API Endpoint

```
GET /api/admin/users
```

**Response:**
```json
{
  "success": true,
  "users": [
    {
      "id": "uuid",
      "email": "user@example.com",
      "created_at": "2026-01-08T13:13:40.716Z",
      "email_confirmed_at": "2026-01-08T13:13:40.716Z",
      "last_sign_in_at": null,
      "role": "admin"
    }
  ],
  "total": 3
}
```

### Access Control

| User Type | Access |
|-----------|--------|
| Guest | ❌ Redirect to login |
| Regular User | ❌ Redirect to home |
| Admin (role=admin) | ✅ Full access |
| Admin (@admin.tarotapp.com) | ✅ Full access |

## Dev Notes

- Feature was created ad-hoc based on user request during Sprint 5
- Uses same admin access control pattern as Analytics Dashboard
- Requires either:
  - `SUPABASE_SERVICE_ROLE_KEY` for full auth.users access, OR
  - Synced data in public.users table with proper RLS policies

## Testing Checklist

- [x] Admin can view all users
- [x] Non-admin cannot access page
- [x] Search filter works
- [x] Sort columns work
- [x] Stats display correctly
- [x] Link to Analytics works

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-08 | Story created and implemented | AI Agent |

