# Story 9.2: AI-Powered Personalized Interpretations (VIP Feature)

## Status
**Ready for Review**

## Story
**As a** VIP user, **I want** AI-personalized interpretations based on my question and history, **so that** readings feel uniquely relevant.

## Acceptance Criteria
1. AI interpretation option: toggle on reading result
2. Uses Anthropic Claude API with user context
3. Analyzes: user question + cards drawn + reading history
4. Generates personalized advice (200-300 words)
5. VIP tier exclusive feature
6. Costs managed: API usage tracking
7. Quality: AI output reviewed for appropriateness
8. Privacy: user data not stored by Anthropic
9. Fallback: standard interpretation if AI fails
10. Analytics: AI usage rate, user satisfaction

## Tasks / Subtasks
- [x] **Task 1: Claude API Integration**
  - [x] API client setup
  - [x] Prompt engineering
- [x] **Task 2: Context Building**
  - [x] User question
  - [x] Cards drawn
  - [x] Optional: reading history
- [x] **Task 3: UI Toggle**
  - [x] "Get AI Personalized Reading" button
- [x] **Task 4: Cost Management**
  - [x] Track API usage
  - [x] Set limits per user
- [x] **Task 5: Quality & Safety**
  - [x] Content moderation
  - [x] Appropriate responses
- [x] **Task 6: Testing**
  - [x] AI output quality

## Dev Notes
**VIP Feature:** Premium differentiator
**AI:** Claude 3.5 Sonnet for Thai quality
**Budget:** Monitor costs (~à¸¿500-2,000/month)

## File List
| File | Action | Description |
|------|--------|-------------|
| `apps/web/src/lib/config.ts` | Modified | Added AI configuration section |
| `apps/web/src/lib/ai/types.ts` | Created | AI interpretation types |
| `apps/web/src/lib/ai/prompts.ts` | Created | Thai prompt engineering for tarot |
| `apps/web/src/lib/ai/anthropic.ts` | Created | Claude API client wrapper |
| `apps/web/src/lib/ai/rate-limiting.ts` | Created | Rate limiting and caching |
| `apps/web/src/lib/ai/index.ts` | Created | AI module exports |
| `apps/web/src/app/api/ai/interpret/route.ts` | Created | AI interpretation API endpoint |
| `apps/web/src/lib/hooks/useAIInterpretation.ts` | Created | React hook for AI interpretation |
| `apps/web/src/lib/hooks/index.ts` | Modified | Added AI hook export |
| `apps/web/src/components/ai/AIInterpretationToggle.tsx` | Created | VIP toggle button component |
| `apps/web/src/components/ai/AIInterpretation.tsx` | Created | AI interpretation display |
| `apps/web/src/components/ai/index.ts` | Created | AI components exports |
| `apps/web/src/app/reading/three-card/page.tsx` | Modified | Integrated AI feature |
| `apps/web/tests/unit/ai-interpretation.test.ts` | Created | 42 unit tests |
| `apps/web/package.json` | Modified | Added @anthropic-ai/sdk |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Debug Log References
N/A - No blocking issues encountered

### Completion Notes
- Implemented full Claude API integration with Anthropic SDK
- Created Thai-language tarot interpretation prompts with safety guidelines
- VIP-only feature with rate limiting (10 requests/day default)
- Response caching (24-hour expiry) to reduce API costs
- Graceful fallback to standard interpretation when AI unavailable
- All 42 unit tests pass, covering prompts, rate limiting, caching, and quality
- UI toggle integrated into three-card reading page as example
- Cost tracking and daily aggregation for monitoring

### Environment Variables Required
```
ANTHROPIC_API_KEY=your-api-key
AI_MODEL=claude-3-5-sonnet-20241022
AI_MAX_TOKENS=800
AI_TEMPERATURE=0.7
AI_MAX_REQUESTS_PER_DAY=10
AI_TIMEOUT_MS=10000
AI_DAILY_COST_ALERT=100
AI_CACHE_ENABLED=true
AI_CACHE_EXPIRY_HOURS=24
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Phase 4 story | Sarah (PO) |
| 2026-01-17 | 1.1 | Implementation complete | James (Dev) |

