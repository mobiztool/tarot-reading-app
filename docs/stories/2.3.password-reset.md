# Story 2.3: Password Reset Flow

## Status

**Approved**

---

## Story

**As a** user who forgot my password,  
**I want** to reset it via email,  
**so that** I can regain access to my account without contacting support.

---

## Acceptance Criteria

1. Password reset request page (`/auth/forgot-password`) created with email input field
2. User submits email, Supabase sends password reset email
3. Success message: "Password reset link sent to your email" (even if email not found - security)
4. Reset email contains magic link valid for 1 hour
5. Clicking link redirects to password reset page (`/auth/reset-password`) with token
6. Reset password page: new password input, confirm password input, submit button
7. Password validation: same rules as signup (8+ chars, mixed case, number)
8. Successful reset: password updated, user auto-logged in, redirected to profile
9. Expired token: show "Reset link expired, request a new one" message
10. Analytics tracked: `password_reset_requested`, `password_reset_completed`

---

## Tasks / Subtasks

- [ ] **Task 1: Create Forgot Password Page** (AC: 1)
  - [ ] Create `src/app/auth/forgot-password/page.tsx`
  - [ ] Simple form with email input only
  - [ ] Add helpful text: "Enter your email to receive reset link"
  - [ ] Submit button: "Send Reset Link"
  - [ ] Link back to login page
  - [ ] Style consistent with other auth pages

- [ ] **Task 2: Implement Reset Request** (AC: 2, 3)
  - [ ] Create handler:
    ```typescript
    const handleResetRequest = async (email: string) => {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/auth/reset-password`,
      });

      // Always show success (security - don't reveal if email exists)
      setSuccess(true);
      setMessage('If an account exists, you will receive a reset link.');
    };
    ```
  - [ ] Show success message regardless of email validity
  - [ ] Security: don't reveal if email exists in system

- [ ] **Task 3: Configure Reset Email Template** (AC: 4)
  - [ ] Update Supabase email template
  - [ ] Customize email content:
    - Subject: "Reset Your Password - [App Name]"
    - Body: Instructions + magic link button
    - Include branding (logo, colors)
  - [ ] Set expiration: 1 hour (3600 seconds)
  - [ ] Test email delivery

- [ ] **Task 4: Create Reset Password Page** (AC: 5, 6)
  - [ ] Create `src/app/auth/reset-password/page.tsx`
  - [ ] Extract token from URL params
  - [ ] Form fields:
    - New password input
    - Confirm password input
  - [ ] Add password strength indicator (reuse from signup)
  - [ ] Submit button: "Reset Password"

- [ ] **Task 5: Validate Token** (AC: 5, 9)
  - [ ] On page load, check if token valid:
    ```typescript
    useEffect(() => {
      supabase.auth.getSession().then(({ data: { session }, error }) => {
        if (error || !session) {
          setTokenExpired(true);
        }
      });
    }, []);
    ```
  - [ ] If expired: show error message with link to request new reset
  - [ ] If valid: show password reset form

- [ ] **Task 6: Implement Password Update** (AC: 7, 8)
  - [ ] Create update handler:
    ```typescript
    const handlePasswordUpdate = async (newPassword: string) => {
      const { error } = await supabase.auth.updateUser({
        password: newPassword,
      });

      if (error) throw error;

      // User is automatically logged in after password update
      router.push('/profile');
      trackEvent('password_reset_completed');
    };
    ```
  - [ ] Validate password (reuse schema from signup)
  - [ ] Handle errors
  - [ ] Auto-login after successful reset

- [ ] **Task 7: Password Validation** (AC: 7)
  - [ ] Reuse validation from Story 2.1:
    ```typescript
    const resetPasswordSchema = z
      .object({
        password: z
          .string()
          .min(8, 'Password must be at least 8 characters')
          .regex(/[A-Z]/, 'Must contain uppercase letter')
          .regex(/[a-z]/, 'Must contain lowercase letter')
          .regex(/[0-9]/, 'Must contain number'),
        confirmPassword: z.string(),
      })
      .refine((data) => data.password === data.confirmPassword, {
        message: "Passwords don't match",
        path: ['confirmPassword'],
      });
    ```
  - [ ] Show validation errors inline

- [ ] **Task 8: Error Handling** (AC: 9)
  - [ ] Handle common errors:
    - Expired token: "Reset link expired. Request a new one."
    - Invalid token: "Invalid reset link. Please try again."
    - Weak password: Show validation errors
    - Network error: "Connection failed. Try again."
  - [ ] Provide recovery actions (request new link)

- [ ] **Task 9: Success Flow** (AC: 8)
  - [ ] Show success message: "Password updated successfully!"
  - [ ] Auto-login user (Supabase does this automatically)
  - [ ] Redirect to profile page after 2 seconds
  - [ ] Show loading state during redirect

- [ ] **Task 10: Analytics Tracking** (AC: 10)
  - [ ] Track events:
    - `password_reset_requested`:
      ```typescript
      trackEvent('password_reset_requested', {
        from_page: 'forgot_password',
      });
      ```
    - `password_reset_completed`:
      ```typescript
      trackEvent('password_reset_completed', {
        auto_login: true,
      });
      ```
  - [ ] Verify in GA4

- [ ] **Task 11: Email Deliverability** (AC: 2, 4)
  - [ ] Test reset email arrives promptly
  - [ ] Check spam folder if not in inbox
  - [ ] Verify email formatting (mobile and desktop)
  - [ ] Test magic link works
  - [ ] Verify link expires after 1 hour

- [ ] **Task 12: Security Measures** (AC: 3)
  - [ ] Don't reveal if email exists (always show success)
  - [ ] Rate limit reset requests (max 3 per hour per IP)
  - [ ] Single-use tokens (can't reuse same link)
  - [ ] Require email verification before reset (if not verified)

- [ ] **Task 13: Testing** (AC: 1-10)
  - [ ] E2E test:
    ```typescript
    test('complete password reset flow', async ({ page }) => {
      // Request reset
      await page.goto('/auth/forgot-password');
      await page.fill('[name="email"]', 'test@example.com');
      await page.click('button[type="submit"]');
      await expect(page.locator('text=reset link sent')).toBeVisible();

      // Check email and click link (manual step in real test)
      // For E2E, we can get the token directly from Supabase

      // Reset password
      await page.goto(`/auth/reset-password?token=xxx`);
      await page.fill('[name="password"]', 'NewPassword123');
      await page.fill('[name="confirmPassword"]', 'NewPassword123');
      await page.click('button[type="submit"]');
      await expect(page).toHaveURL('/profile');
    });
    ```
  - [ ] Test expired token
  - [ ] Test invalid token
  - [ ] Test weak password validation

- [ ] **Task 14: Documentation** (AC: 1-10)
  - [ ] Document password reset flow
  - [ ] Document email template customization
  - [ ] Document troubleshooting steps
  - [ ] Commit: "feat: Add password reset flow"

---

## Dev Notes

### Previous Story Insights

**From Story 2.1 (Signup):**

- Password validation schema reusable
- Password strength indicator component ready

**From Story 2.2 (Login):**

- Auto-login flow established

**Integration Points:**

- Forgot password link on login page
- After reset: redirect to profile (Story 2.4)

---

### Password Reset Flow Diagram

```
User                     App                      Supabase
  |                       |                          |
  |-- Enter email ------->|                          |
  |                       |-- resetPasswordForEmail ->|
  |                       |                          |-- Send email
  |<------ Success msg ---|                          |
  |                       |                          |
  |-- Click email link -->|                          |
  |                       |-- Check token ---------->|
  |                       |<-- Token valid ----------|
  |                       |                          |
  |-- Enter new password->|                          |
  |                       |-- updateUser ----------->|
  |                       |<-- Password updated -----|
  |                       |<-- Auto-login -----------|
  |<------ Redirect ------|                          |
```

---

### Supabase Reset Password API

**Request Reset:**

```typescript
const { error } = await supabase.auth.resetPasswordForEmail(email, {
  redirectTo: `${window.location.origin}/auth/reset-password`,
});
```

**Update Password:**

```typescript
const { error } = await supabase.auth.updateUser({
  password: newPassword,
});
// User is automatically logged in after this
```

[Source: architecture/backend-architecture.md]

---

### Email Template Customization

**Supabase Dashboard:**

1. Go to Authentication â†’ Email Templates
2. Edit "Reset Password" template
3. Customize:
   - Subject line
   - Email body (HTML)
   - Button text and link
   - Branding (logo, colors)

**Template Variables:**

- `{{ .ConfirmationURL }}` - Magic link
- `{{ .SiteURL }}` - App URL
- `{{ .TokenHash }}` - Token for custom flows

---

### Testing Strategy

**Unit Tests:**

- Password validation
- Token validation logic

**Integration Tests:**

- Supabase reset API
- Email delivery (can't fully automate)

**E2E Tests:**

- Request reset flow
- Update password flow
- Expired token handling

**Manual Testing:**

- Real email delivery
- Email formatting
- Link expiration (wait 1 hour)

**Coverage Target:**

- Reset flow: >85%
- Validation: 100%

[Source: architecture/testing-strategy.md]

---

### Notes

**Important:**

- Don't reveal if email exists (security)
- Magic links expire after 1 hour
- Single-use tokens
- Auto-login after successful reset

**Dependencies:**

- **Story 2.1 completed**: Signup with password validation
- **Story 2.2 completed**: Login functionality

**Blockers:**

- None

**Future Considerations:**

- SMS password reset (in addition to email)
- Security questions
- Backup codes
- Admin-initiated password reset

---

## Change Log

| Date       | Version | Description            | Author           |
| ---------- | ------- | ---------------------- | ---------------- |
| 2026-01-01 | 1.0     | Initial story creation | Sarah (PO Agent) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by the QA Agent after story completion._
