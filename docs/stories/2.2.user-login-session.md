# Story 2.2: User Login & Session Management

## Status

**Approved**

---

## Story

**As a** returning user,  
**I want** to login quickly and stay logged in,  
**so that** I don't have to re-authenticate every time I visit the app.

---

## Acceptance Criteria

1. Login page (`/auth/login`) created with form: email, password
2. "Login with Google" and "Login with Facebook" buttons available
3. "Remember me" checkbox keeps user logged in for 30 days
4. "Forgot password?" link navigates to password reset flow
5. Successful login: user redirected to previous page or home page
6. Session persisted using Supabase Auth tokens (stored in cookies)
7. Session refresh: automatically refresh token before expiration
8. Error handling: invalid credentials show "Email or password incorrect"
9. Rate limiting: prevent brute force attacks (max 5 attempts per 15 minutes)
10. Logout functionality: clears session and redirects to home
11. Protected routes: redirect to login if accessing history/profile without auth
12. Auto-login: skip login if valid session exists
13. Analytics tracked: `login_completed`, `login_method`, `logout_completed`

---

## Tasks / Subtasks

- [ ] **Task 1: Create Login Page** (AC: 1, 4)
  - [ ] Create `src/app/auth/login/page.tsx`
  - [ ] Add metadata for SEO
  - [ ] Create form with React Hook Form
  - [ ] Form fields: email, password, remember me checkbox
  - [ ] Add "Forgot password?" link to `/auth/forgot-password`
  - [ ] Style consistent with signup page
  - [ ] Mobile responsive

- [ ] **Task 2: Implement Email/Password Login** (AC: 1, 3, 5)
  - [ ] Create login handler:
    ```typescript
    const handleLogin = async (data: LoginFormData) => {
      const { data: authData, error } = await supabase.auth.signInWithPassword({
        email: data.email,
        password: data.password,
      });

      if (error) throw error;

      // Redirect to intended page or home
      const redirectTo = searchParams.get('redirectTo') || '/';
      router.push(redirectTo);
    };
    ```
  - [ ] Handle "remember me": set session duration
  - [ ] Handle errors: show user-friendly messages
  - [ ] Track analytics: `login_completed`

- [ ] **Task 3: Add OAuth Login Buttons** (AC: 2)
  - [ ] Add "Login with Google" button (reuse from signup)
  - [ ] Add "Login with Facebook" button
  - [ ] Implement same OAuth handlers as signup
  - [ ] Test OAuth login flows

- [ ] **Task 4: Session Persistence** (AC: 6, 7)
  - [ ] Configure Supabase to use cookies (not localStorage)
  - [ ] Middleware to refresh tokens automatically:

    ```typescript
    // middleware.ts
    import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';

    export async function middleware(req: NextRequest) {
      const res = NextResponse.next();
      const supabase = createMiddlewareClient({ req, res });
      await supabase.auth.getSession(); // Refreshes token if needed
      return res;
    }
    ```

  - [ ] Test: verify session persists after browser close
  - [ ] Test: verify token refresh before expiration

- [ ] **Task 5: Remember Me Functionality** (AC: 3)
  - [ ] Add checkbox to login form
  - [ ] If checked: set session duration to 30 days
  - [ ] If unchecked: use default (7 days)
  - [ ] Store preference in session metadata

- [ ] **Task 6: Error Handling** (AC: 8)
  - [ ] Handle common login errors:
    - Invalid credentials: "Email or password incorrect"
    - Email not verified: "Please verify your email first"
    - User not found: "Email or password incorrect" (same message for security)
    - Network error: "Connection failed, try again"
  - [ ] Show errors in toast or inline message
  - [ ] Log errors to Sentry

- [ ] **Task 7: Rate Limiting** (AC: 9)
  - [ ] Implement client-side rate limiting:

    ```typescript
    const [attempts, setAttempts] = useState(0);
    const [lockUntil, setLockUntil] = useState<Date | null>(null);

    const handleLogin = async (data) => {
      if (lockUntil && Date.now() < lockUntil.getTime()) {
        throw new Error('Too many attempts. Try again later.');
      }

      try {
        await supabase.auth.signInWithPassword(...);
        setAttempts(0); // Reset on success
      } catch (error) {
        setAttempts(prev => prev + 1);

        if (attempts >= 4) { // 5th failed attempt
          setLockUntil(new Date(Date.now() + 15 * 60 * 1000)); // 15 min
        }
      }
    };
    ```

  - [ ] Show lockout message with timer
  - [ ] Consider server-side rate limiting (Supabase has built-in)

- [ ] **Task 8: Logout Functionality** (AC: 10)
  - [ ] Add logout button to navigation (Story 2.10)
  - [ ] Implement logout handler:
    ```typescript
    const handleLogout = async () => {
      await supabase.auth.signOut();
      router.push('/');
      trackEvent('logout_completed');
    };
    ```
  - [ ] Clear local state
  - [ ] Redirect to home page
  - [ ] Show success message (optional)

- [ ] **Task 9: Protected Routes** (AC: 11)
  - [ ] Create auth middleware for protected routes:
    ```typescript
    // middleware.ts
    export async function middleware(req: NextRequest) {
      const supabase = createMiddlewareClient({ req, res });
      const {
        data: { session },
      } = await supabase.auth.getSession();

      // Protected routes
      if (
        req.nextUrl.pathname.startsWith('/history') ||
        req.nextUrl.pathname.startsWith('/profile')
      ) {
        if (!session) {
          return NextResponse.redirect(
            new URL(`/auth/login?redirectTo=${req.nextUrl.pathname}`, req.url)
          );
        }
      }

      return res;
    }
    ```
  - [ ] Apply to routes: `/history`, `/profile`, `/settings`
  - [ ] Pass redirect URL to login page
  - [ ] Test: verify redirects work

- [ ] **Task 10: Auto-Login** (AC: 12)
  - [ ] Check session on app load
  - [ ] If valid session: skip login, show logged-in state
  - [ ] If on login page with valid session: redirect to home
  - [ ] Implementation in useAuth hook:
    ```typescript
    useEffect(() => {
      const checkSession = async () => {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        if (session && router.pathname === '/auth/login') {
          router.push('/');
        }
      };
      checkSession();
    }, []);
    ```

- [ ] **Task 11: Redirect After Login** (AC: 5)
  - [ ] Capture intended destination before redirect to login
  - [ ] Store in URL param: `/auth/login?redirectTo=/history`
  - [ ] After successful login: redirect to intended page
  - [ ] Default to home if no redirect param

- [ ] **Task 12: Analytics Tracking** (AC: 13)
  - [ ] Track events:
    - `login_started`: When user lands on login page
    - `login_method_selected`: When clicking OAuth button
    - `login_completed`:
      ```typescript
      trackEvent('login_completed', {
        login_method: 'email', // or 'google', 'facebook'
        remember_me: rememberMe,
      });
      ```
    - `logout_completed`: When user logs out
  - [ ] Verify events in GA4

- [ ] **Task 13: Loading & Disabled States** (AC: 5)
  - [ ] Show loading spinner during login
  - [ ] Disable form during submission
  - [ ] Button text: "Logging in..."
  - [ ] Disable OAuth buttons while processing

- [ ] **Task 14: Testing** (AC: 1-13)
  - [ ] E2E tests:

    ```typescript
    test('login with email and password', async ({ page }) => {
      await page.goto('/auth/login');
      await page.fill('[name="email"]', 'test@example.com');
      await page.fill('[name="password"]', 'Password123');
      await page.click('button[type="submit"]');
      await expect(page).toHaveURL('/');
    });

    test('logout', async ({ page }) => {
      // Login first
      await page.goto('/');
      await page.click('[data-testid="user-menu"]');
      await page.click('text=Logout');
      await expect(page.locator('text=Login')).toBeVisible();
    });
    ```

  - [ ] Test protected routes redirect
  - [ ] Test session persistence
  - [ ] Test rate limiting

- [ ] **Task 15: Documentation** (AC: 1-13)
  - [ ] Document login flow
  - [ ] Document session management
  - [ ] Document protected routes setup
  - [ ] Commit: "feat: Add user login and session management"

---

## Dev Notes

### Previous Story Insights

**From Story 2.1 (Signup):**

- Supabase Auth configured
- OAuth providers ready
- useAuth hook available

**Integration Points:**

- Protected routes redirect here
- After login: access history, profile
- Session state affects navigation

---

### Session Management

**Token Storage (Cookies vs LocalStorage):**

```typescript
// Use cookies for better security (httpOnly, secure)
const supabase = createClientComponentClient({
  cookies: {
    get(name) {
      return getCookie(name);
    },
    set(name, value, options) {
      setCookie(name, value, options);
    },
    remove(name) {
      removeCookie(name);
    },
  },
});
```

**Auto Token Refresh:**

- Supabase handles automatically
- Refresh token before access token expires
- No user action needed
- Happens in background

[Source: architecture/backend-architecture.md]

---

### Protected Routes Middleware

```typescript
// middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });

  const {
    data: { session },
  } = await supabase.auth.getSession();

  // Protected routes
  const protectedPaths = ['/history', '/profile', '/settings'];
  const isProtected = protectedPaths.some((path) => req.nextUrl.pathname.startsWith(path));

  if (isProtected && !session) {
    const redirectUrl = new URL('/auth/login', req.url);
    redirectUrl.searchParams.set('redirectTo', req.nextUrl.pathname);
    return NextResponse.redirect(redirectUrl);
  }

  return res;
}

export const config = {
  matcher: ['/history/:path*', '/profile/:path*', '/settings/:path*'],
};
```

---

### Rate Limiting Implementation

**Client-Side:**

```typescript
// hooks/useRateLimiter.ts
export function useRateLimiter(maxAttempts = 5, lockoutMinutes = 15) {
  const [attempts, setAttempts] = useState(0);
  const [lockedUntil, setLockedUntil] = useState<number | null>(null);

  const isLocked = lockedUntil && Date.now() < lockedUntil;

  const recordAttempt = (success: boolean) => {
    if (success) {
      setAttempts(0);
      setLockedUntil(null);
    } else {
      const newAttempts = attempts + 1;
      setAttempts(newAttempts);

      if (newAttempts >= maxAttempts) {
        setLockedUntil(Date.now() + lockoutMinutes * 60 * 1000);
      }
    }
  };

  return { isLocked, remainingAttempts: maxAttempts - attempts, recordAttempt };
}
```

**Server-Side (Supabase):**

- Supabase has built-in rate limiting
- Configurable in dashboard
- No additional code needed

---

### Testing Strategy

**Unit Tests:**

- Login validation
- Rate limiter logic
- Session check functions

**Integration Tests:**

- Supabase auth API
- Token refresh
- Protected route checks

**E2E Tests:**

- Login flow
- Logout flow
- Protected route redirect
- Session persistence
- Rate limiting (5 failed attempts)

**Coverage Target:**

- Auth flows: >90%
- Session management: >85%

[Source: architecture/testing-strategy.md]

---

### Notes

**Important:**

- Use cookies (not localStorage) for security
- Auto token refresh = seamless UX
- Rate limiting prevents brute force
- Protected routes enforce authentication

**Dependencies:**

- **Story 2.1 completed**: Signup with Supabase Auth
- No blockers

**Blockers:**

- None

**Future Considerations:**

- Multi-device sessions (see all logged-in devices)
- Force logout from all devices
- Login notifications (security alert)
- Biometric auth (Touch ID, Face ID)

---

## Change Log

| Date       | Version | Description            | Author           |
| ---------- | ------- | ---------------------- | ---------------- |
| 2026-01-01 | 1.0     | Initial story creation | Sarah (PO Agent) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by the QA Agent after story completion._
