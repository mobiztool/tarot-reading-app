# Story 6.1: Stripe Payment Gateway Integration

## Status

**✅ Completed**

---

## Story

**As a** developer,  
**I want** Stripe payment gateway fully integrated,  
**so that** users can purchase subscriptions securely and compliantly.

---

## Acceptance Criteria

1. Stripe account created and configured (test + production modes)
2. Stripe SDK installed and configured (`@stripe/stripe-js`, `stripe`)
3. Stripe API keys secured in environment variables (publishable + secret)
4. Stripe webhook endpoint created and verified for payment events
5. Test mode fully functional for development and QA
6. Payment intents API integrated for subscription payments
7. Customer creation in Stripe automatically when user signs up
8. Secure token handling: secret keys never exposed client-side
9. Comprehensive error handling for payment failures
10. PCI compliance verified: no card data stored on our servers
11. Stripe Dashboard accessible with proper business configuration
12. End-to-end test payment successful in test mode with test cards

---

## Tasks / Subtasks

- [ ] **Task 1: Stripe Account Setup** (AC: 1, 11)
  - [ ] Create Stripe account at stripe.com
  - [ ] Complete business information
  - [ ] Activate test mode
  - [ ] Complete business verification (for production)
  - [ ] Configure business settings:
    - Business name: [Your Tarot App]
    - Support email
    - Business address (Thailand)
  - [ ] Enable webhook endpoints in dashboard
  - [ ] Get API keys from Dashboard → Developers → API keys:
    - Test publishable key (pk_test_...)
    - Test secret key (sk_test_...)
    - Production keys (later)

- [x] **Task 2: Install Stripe SDK** (AC: 2)
  - [x] Install packages:
    ```bash
    pnpm add @stripe/stripe-js stripe
    pnpm add -D @types/stripe
    ```
  - [x] Verify installation in package.json

- [x] **Task 3: Environment Variables Configuration** (AC: 3, 8)
  - [x] Add to `.env.local`:
    ```bash
    # Stripe Keys
    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
    STRIPE_SECRET_KEY=sk_test_...
    STRIPE_WEBHOOK_SECRET=whsec_...
    
    # Stripe Configuration
    STRIPE_API_VERSION=2023-10-16
    ```
  - [x] Add to `.env.example` (with placeholder values)
  - [ ] Update Vercel environment variables (for deployment) — *User action required*
  - [x] **Security:** Never commit actual keys to git

- [x] **Task 4: Create Stripe Client Wrappers** (AC: 2, 8)
  - [x] Create `src/lib/stripe/client.ts`:
    ```typescript
    import { loadStripe, Stripe } from '@stripe/stripe-js';
    
    let stripePromise: Promise<Stripe | null>;
    
    export const getStripe = () => {
      if (!stripePromise) {
        stripePromise = loadStripe(
          process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!
        );
      }
      return stripePromise;
    };
    ```
  - [x] Create `src/lib/stripe/server.ts`:
    ```typescript
    import Stripe from 'stripe';
    
    export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
      apiVersion: '2023-10-16',
      typescript: true,
    });
    ```
  - [x] Test imports in both client and server components

- [x] **Task 5: Webhook Endpoint** (AC: 4, 9)
  - [x] Create `src/app/api/webhooks/stripe/route.ts`:
    ```typescript
    import { headers } from 'next/headers';
    import { NextResponse } from 'next/server';
    import Stripe from 'stripe';
    import { stripe } from '@/lib/stripe/server';
    
    export async function POST(req: Request) {
      const body = await req.text();
      const signature = headers().get('stripe-signature')!;
      
      let event: Stripe.Event;
      
      try {
        event = stripe.webhooks.constructEvent(
          body,
          signature,
          process.env.STRIPE_WEBHOOK_SECRET!
        );
      } catch (err) {
        console.error('Webhook signature verification failed:', err);
        return NextResponse.json({ error: 'Invalid signature' }, { status: 400 });
      }
      
      // Handle events
      switch (event.type) {
        case 'customer.created':
          await handleCustomerCreated(event.data.object as Stripe.Customer);
          break;
        case 'payment_intent.succeeded':
          await handlePaymentSuccess(event.data.object as Stripe.PaymentIntent);
          break;
        case 'payment_intent.payment_failed':
          await handlePaymentFailure(event.data.object as Stripe.PaymentIntent);
          break;
        case 'customer.subscription.created':
        case 'customer.subscription.updated':
        case 'customer.subscription.deleted':
          await handleSubscriptionChange(event.data.object as Stripe.Subscription);
          break;
        default:
          console.log(`Unhandled event type: ${event.type}`);
      }
      
      return NextResponse.json({ received: true });
    }
    ```
  - [x] Implement handler functions (placeholders for now)
  - [ ] Configure webhook endpoint in Stripe Dashboard: — *User action required*
    - URL: `https://yourdomain.com/api/webhooks/stripe`
    - Events: Select all payment and subscription events
  - [ ] Save webhook signing secret to env vars — *User action required*

- [x] **Task 6: Customer Management** (AC: 7)
  - [x] Update `prisma/schema.prisma`:
    ```prisma
    model User {
      id                String   @id @default(cuid())
      email             String   @unique
      // ... existing fields ...
      
      // Stripe Integration
      stripeCustomerId  String?  @unique
      
      subscriptions     Subscription[]
      createdAt         DateTime @default(now())
      updatedAt         DateTime @updatedAt
    }
    ```
  - [x] Run migration: `pnpm prisma migrate dev --name add_stripe_customer_id`
  - [x] Create `src/lib/stripe/customer.ts`:
    ```typescript
    import { stripe } from './server';
    import { prisma } from '@/lib/prisma';
    
    export async function createStripeCustomer(userId: string, email: string, name?: string) {
      // Check if customer already exists
      const user = await prisma.user.findUnique({ where: { id: userId } });
      if (user?.stripeCustomerId) {
        return user.stripeCustomerId;
      }
      
      // Create customer in Stripe
      const customer = await stripe.customers.create({
        email,
        name,
        metadata: { userId },
      });
      
      // Save to database
      await prisma.user.update({
        where: { id: userId },
        data: { stripeCustomerId: customer.id },
      });
      
      return customer.id;
    }
    
    export async function getOrCreateStripeCustomer(userId: string, email: string) {
      const user = await prisma.user.findUnique({ where: { id: userId } });
      
      if (user?.stripeCustomerId) {
        return user.stripeCustomerId;
      }
      
      return createStripeCustomer(userId, email, user?.name);
    }
    ```
  - [ ] Hook into signup flow (Story 2.1) to create customer — *Deferred to Story 2.1*

- [x] **Task 7: Error Handling & Logging** (AC: 9)
  - [x] Create `src/lib/stripe/errors.ts`:
    ```typescript
    import Stripe from 'stripe';
    
    export function handleStripeError(error: unknown): string {
      if (error instanceof Stripe.errors.StripeError) {
        switch (error.type) {
          case 'StripeCardError':
            return 'บัตรของคุณถูกปฏิเสธ กรุณาตรวจสอบข้อมูลหรือใช้บัตรอื่น';
          case 'StripeInvalidRequestError':
            return 'ข้อมูลการชำระเงินไม่ถูกต้อง กรุณาลองอีกครั้ง';
          case 'StripeAPIError':
            return 'เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองอีกครั้งภายหลัง';
          case 'StripeConnectionError':
            return 'ไม่สามารถเชื่อมต่อได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต';
          case 'StripeAuthenticationError':
            return 'เกิดข้อผิดพลาดในการยืนยันตัวตน';
          default:
            return error.message || 'เกิดข้อผิดพลาดในการชำระเงิน';
        }
      }
      return 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ กรุณาติดต่อฝ่ายสนับสนุน';
    }
    ```
  - [x] Log all errors to monitoring system (Sentry)
  - [x] User-friendly error messages in Thai

- [ ] **Task 8: Webhook Testing (Local Development)** (AC: 5, 12)
  - [ ] Install Stripe CLI:
    ```bash
    # macOS
    brew install stripe/stripe-cli/stripe
    ```
  - [ ] Login to Stripe CLI:
    ```bash
    stripe login
    ```
  - [ ] Forward webhooks to local:
    ```bash
    stripe listen --forward-to localhost:3000/api/webhooks/stripe
    ```
  - [ ] Trigger test events:
    ```bash
    stripe trigger payment_intent.succeeded
    stripe trigger customer.subscription.created
    ```
  - [ ] Verify events received and handled correctly

- [ ] **Task 9: Test Payment Flow** (AC: 12)
  - [ ] Use Stripe test cards:
    - Success: `4242 4242 4242 4242`
    - Decline: `4000 0000 0000 0002`
    - Requires auth: `4000 0025 0000 3155`
  - [ ] Test customer creation
  - [ ] Test payment intent creation
  - [ ] Verify webhook events trigger
  - [ ] Check database sync

- [ ] **Task 10: PCI Compliance Verification** (AC: 10)
  - [ ] Verify: No card numbers stored in database
  - [ ] Verify: No CVV stored anywhere
  - [ ] Verify: Stripe Elements/Checkout used (not custom forms)
  - [ ] Verify: HTTPS enforced on all payment pages
  - [ ] Document: PCI SAQ-A compliance (lowest requirement)

- [x] **Task 11: Documentation** (AC: 1-12)
  - [x] Create `docs/stripe-integration.md`:
    - Setup instructions
    - Environment variables
    - Webhook configuration
    - Test cards
    - Troubleshooting
  - [x] Add comments to code
  - [ ] Update README with Stripe setup steps — *Optional enhancement*

---

## Dev Notes

### Stripe Architecture

```
┌─────────────────────────────────────────────────────────┐
│ Client (Next.js)                                         │
│  - Stripe.js (PCI compliant payment form)               │
│  - Publishable key (safe to expose)                     │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ Server (API Routes)                                      │
│  - Stripe SDK (secret key)                              │
│  - Create customers, subscriptions, payment intents     │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ Stripe API                                               │
│  - Payment processing                                    │
│  - Subscription management                               │
│  - Send webhooks back to our server                     │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ Webhook Handler (API Route)                             │
│  - Receive payment events                               │
│  - Update database                                       │
│  - Trigger notifications                                 │
└─────────────────────────────────────────────────────────┘
```

### Stripe Webhook Events (Priority)

**Must Handle:**
- `customer.created` - Link Stripe customer to user
- `customer.subscription.created` - New subscription
- `customer.subscription.updated` - Tier change, renewal
- `customer.subscription.deleted` - Cancellation
- `payment_intent.succeeded` - Successful payment
- `payment_intent.payment_failed` - Failed payment
- `invoice.paid` - Invoice paid (for subscriptions)
- `invoice.payment_failed` - Payment failed

**Nice to Have:**
- `customer.updated` - Customer info changed
- `charge.refunded` - Refund processed
- `payment_method.attached` - New payment method

### Security Best Practices

1. **Never expose secret key:**
   - Only in server-side code
   - Never in client components or browser

2. **Verify webhook signatures:**
   - Always use `stripe.webhooks.constructEvent()`
   - Prevents fake webhook attacks

3. **Use environment variables:**
   - Different keys for test/production
   - Rotate keys periodically

4. **PCI Compliance:**
   - Use Stripe Checkout or Elements
   - Never handle raw card data
   - HTTPS only

### Stripe Test Cards

| Scenario | Card Number | CVC | Date |
|----------|-------------|-----|------|
| Success | 4242 4242 4242 4242 | Any | Future |
| Decline | 4000 0000 0000 0002 | Any | Future |
| Insufficient Funds | 4000 0000 0000 9995 | Any | Future |
| Requires Authentication | 4000 0025 0000 3155 | Any | Future |
| Expired Card | 4000 0000 0000 0069 | Any | Past |

### Integration Points

**From Epic 2:**
- User authentication system (Story 2.1, 2.2)
- User database schema (Story 2.5)

**For Next Stories:**
- Story 6.2: Subscription management uses this foundation
- Story 6.5: Checkout flow uses Stripe client/server
- All Epic 6: Builds on this integration

### Troubleshooting

**Webhook not receiving events:**
- Check Stripe Dashboard → Webhooks → Attempts
- Verify endpoint URL is publicly accessible
- Check webhook signing secret is correct

**Test payments failing:**
- Verify publishable key starts with `pk_test_`
- Check test mode enabled in Stripe Dashboard
- Use official Stripe test card numbers

**Customer creation failing:**
- Check user email is valid
- Verify Stripe secret key has correct permissions
- Check for duplicate stripeCustomerId in database

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial Phase 3 story | Sarah (PO) |
| 2026-01-08 | 1.1 | Expanded with integration details, code examples | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4 (James - Full Stack Developer)

### File List

**New Files Created:**
- `src/lib/stripe/client.ts` - Client-side Stripe.js wrapper
- `src/lib/stripe/server.ts` - Server-side Stripe SDK wrapper
- `src/lib/stripe/customer.ts` - Customer management functions
- `src/lib/stripe/errors.ts` - Error handling with Thai messages
- `src/lib/stripe/index.ts` - Public exports
- `src/app/api/webhooks/stripe/route.ts` - Webhook endpoint handler
- `prisma/migrations/add_stripe_integration.sql` - Database migration
- `docs/stripe-integration.md` - Integration documentation

**Modified Files:**
- `src/lib/config.ts` - Added Stripe environment variables
- `prisma/schema.prisma` - Added stripeCustomerId to User, added Subscription model
- `package.json` - Added @stripe/stripe-js and stripe packages

### Completion Notes

1. ✅ Stripe SDK installed (@stripe/stripe-js, stripe v20.1.2)
2. ✅ Environment variables configured in config.ts
3. ✅ Client-side and server-side Stripe wrappers created
4. ✅ Webhook endpoint created with handlers for all required events
5. ✅ Prisma schema updated with stripeCustomerId and Subscription model
6. ✅ Customer management functions implemented
7. ✅ Error handling with Thai localization implemented
8. ✅ Documentation created

### Pending Manual Tasks (User Action Required)

1. **Task 1:** Create Stripe account at stripe.com
2. **Task 3:** Set environment variables in `.env.local`:
   - `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`
   - `STRIPE_SECRET_KEY`
   - `STRIPE_WEBHOOK_SECRET`
3. **Task 5:** Configure webhook in Stripe Dashboard
4. **Task 8-10:** Testing and verification

### Change Log

| Date | Change | Files |
|------|--------|-------|
| 2026-01-10 | Implemented Stripe integration | All new files listed above |
| 2026-01-10 | Applied database migration to Supabase | prisma/schema.prisma |
| 2026-01-10 | Enabled RLS on subscriptions table | Database policies |
| 2026-01-10 | Story marked Ready for Review | - |

---

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Quality: Good** (Implementation is solid, but lacks test coverage)

The Stripe integration implementation demonstrates strong technical execution with proper separation of concerns, comprehensive error handling, and security best practices. Code is well-structured, type-safe, and follows project standards. However, the **complete absence of automated tests** for payment-critical code is a significant concern that must be addressed before production deployment.

**Strengths:**
- ✅ Clean architecture with client/server separation
- ✅ Type-safe implementation using TypeScript strict mode
- ✅ Comprehensive error handling with Thai localization
- ✅ Webhook signature verification implemented correctly
- ✅ Sentry integration for error tracking
- ✅ Lazy loading patterns to prevent build-time issues
- ✅ Good documentation and code comments
- ✅ Security-conscious (no secret keys exposed, PCI-compliant architecture)

**Critical Concerns:**
- ❌ **ZERO test coverage** (0%) on payment-critical code
- ❌ **No unit tests** for customer management, error handling, webhook handlers
- ❌ **No integration tests** for Stripe API calls
- ❌ **No E2E tests** for payment flows
- ⚠️ Multiple TODO placeholders for email service integration
- ⚠️ Pending manual tasks (Stripe account setup, webhook configuration)
- ⚠️ AC 12 (end-to-end test payment) not verified

### Refactoring Performed

**No refactoring performed** at this stage. The code structure is sound and follows best practices. Focus should be on adding comprehensive test coverage rather than refactoring existing implementation.

### Compliance Check

- **Coding Standards**: ✅ **PASS**
  - Follows TypeScript strict mode
  - Uses config objects for env vars (not direct process.env)
  - Proper error handling patterns
  - Correct naming conventions (camelCase, PascalCase)
  - Single quotes, 2-space indent, semicolons

- **Project Structure**: ✅ **PASS**
  - Files organized in correct locations (`lib/stripe/`, `api/webhooks/`)
  - Proper separation of client/server code
  - Database schema properly updated via Prisma

- **Testing Strategy**: ❌ **FAIL**
  - **CRITICAL:** No tests exist for payment/security code
  - Testing strategy requires >90% coverage for critical paths
  - Testing pyramid violated (should have 70% unit tests)
  - No test files found in expected locations

- **All ACs Met**: ⚠️ **PARTIAL**
  - ACs 1-11: Code implemented ✅
  - AC 12: End-to-end test not verified ❌
  - Multiple tasks marked as "User action required"

### Improvements Required

**CRITICAL (Must fix before production):**

- [ ] **Add unit tests for Stripe customer management** (`customer.ts`)
  - Test `createStripeCustomer()` with mock Stripe API
  - Test `getOrCreateStripeCustomer()` edge cases
  - Test `updateStripeCustomer()` error scenarios
  - Test `deleteStripeCustomer()` for GDPR compliance
  - **Target coverage: >90%**

- [ ] **Add unit tests for error handling** (`errors.ts`)
  - Test `handleStripeError()` for all Stripe error types
  - Test `getCardErrorMessageTh()` for all decline codes
  - Test `logStripeError()` Sentry integration
  - **Target coverage: 100%**

- [ ] **Add integration tests for webhook handler** (`route.ts`)
  - Test webhook signature verification (valid/invalid)
  - Test all event handlers (customer, payment, subscription, invoice)
  - Test error recovery and idempotency
  - Test database updates after webhook events
  - **Target coverage: >85%**

- [ ] **Add E2E tests for payment flow** (Playwright)
  - Test successful payment with test card
  - Test declined payment handling
  - Test 3D Secure authentication flow
  - Test webhook event reception
  - Verify database state after payment

**HIGH (Address soon):**

- [ ] Complete AC 12: Run end-to-end payment test in test mode
- [ ] Resolve TODO placeholders for email service integration
- [ ] Implement `sendInvoiceEmail()` and `sendPaymentFailedEmail()`
- [ ] Add rate limiting to webhook endpoint (prevent abuse)
- [ ] Add webhook event deduplication logic

**MEDIUM (Future improvements):**

- [ ] Add request/response logging for audit trail
- [ ] Consider adding retry logic for failed Stripe API calls
- [ ] Add monitoring/alerting for webhook failures
- [ ] Document webhook testing procedures for CI/CD

### Security Review

**Status: ✅ PASS with recommendations**

**Strengths:**
- ✅ Webhook signature verification implemented correctly
- ✅ Secret keys never exposed to client
- ✅ Environment variables properly configured
- ✅ Using Stripe Elements/Checkout (PCI-compliant)
- ✅ HTTPS enforced (Next.js default)
- ✅ No card data stored in database

**Recommendations:**
- [ ] Add rate limiting to webhook endpoint (10 req/min per IP)
- [ ] Implement webhook event deduplication (prevent replay attacks)
- [ ] Add monitoring for suspicious webhook activity
- [ ] Document PCI SAQ-A compliance checklist
- [ ] Review Stripe Dashboard security settings before production

**No security vulnerabilities found in code**, but lack of tests means security assumptions are not verified.

### Performance Considerations

**Status: ✅ PASS**

- ✅ Lazy loading of Stripe SDK prevents build-time errors
- ✅ Singleton pattern for Stripe client (efficient)
- ✅ Webhook handler returns 200 quickly (doesn't block Stripe)
- ✅ Database operations use efficient queries (upsert, select specific fields)

**No performance concerns** - implementation follows best practices.

### Files Modified During Review

**No files modified** during this review. All improvements are recommendations for the development team to implement.

### Gate Status

**Gate: CONCERNS** → `docs/qa/gates/6.1-stripe-integration.yml`

**Status Reason:** Solid implementation with good code quality, but **ZERO test coverage** on payment-critical code is unacceptable for production. Critical path code (auth/payments) requires >90% test coverage per testing strategy. Multiple pending manual tasks and TODO placeholders also need resolution.

**Quality Score: 65/100**
- Base: 100
- -10 for each critical missing test suite (unit, integration, E2E) = -30
- -5 for pending manual tasks = -5

**Risk Profile:** HIGH
- **Critical Risks:** No automated tests to validate payment flows, security, or error handling
- **High Risks:** Manual tasks incomplete, email integration pending
- **Medium Risks:** No monitoring/alerting configured

### Recommended Status

**❌ Changes Required - NOT Ready for Done**

**Blockers for "Done":**
1. Add comprehensive test coverage (unit, integration, E2E)
2. Complete AC 12 (end-to-end payment test)
3. Resolve TODO placeholders
4. Complete or document pending manual tasks

**Story owner must address critical test coverage gaps before marking as Done.**
