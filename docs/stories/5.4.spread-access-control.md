# Story 5.4: Spread Access Control & Feature Gating

## Status
**Ready for Review**

## Story
**As a** product owner, **I want** login-only spreads protected, **so that** guest users have incentive to sign up.

## Acceptance Criteria
1. Spread access matrix implemented (guest vs login)
2. Guest can access: Daily, 3-Card Spread only
3. Login required: Love, Career, Yes/No spreads
4. "Login to unlock" gate on protected spreads
5. Gate UI: attractive modal/page showing benefits
6. CTA: "Sign up free to unlock this spread"
7. Smooth redirect: after login, return to intended spread
8. Track conversion: gate shown → signed up → completed reading
9. Settings page: show which spreads available for user tier
10. Future-proof: ready for Premium tier gating (Phase 3)

## Tasks / Subtasks
- [x] **Task 1: Access Control Logic** (AC: 1, 2, 3)
  - [x] Create `lib/access-control.ts`
  - [x] Function: `canAccessSpread(user, spreadType)`
  - [x] Map spreads to auth requirements (SPREAD_ACCESS_MATRIX)
  - [x] Support 3 tiers: guest, free, premium
  - [x] Future-proof for Premium tier (Phase 3)
- [x] **Task 2: Login Gate Component** (AC: 4, 5, 6)
  - [x] Create `components/gates/LoginGate.tsx`
  - [x] Show spread preview + benefits
  - [x] Signup CTA prominent
  - [x] Track analytics on gate shown
- [x] **Task 3: Middleware/Route Guards** (AC: 7)
  - [x] Protect /reading/love, /career, /yes-no routes (existing middleware)
  - [x] Store redirectTo param
- [x] **Task 4: Analytics** (AC: 8)
  - [x] Track: login_gate_shown, signup_from_gate, gate_conversion
- [x] **Task 5: Testing** (AC: 1-10)
  - [x] Test access control (37 unit tests)
  - [x] Test redirect flow
- [x] **Task 6: Settings Page Integration** (AC: 9)
  - [x] Create SpreadAccessSection component
  - [x] Show available vs locked spreads
  - [x] Display user tier

## Dev Notes
**From Epic 2:** Auth middleware ready (Story 2.2)
**Feature Gating:** Foundation for Premium tier (Phase 3)
**UX:** Gate should feel like upgrade, not blocking

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Phase 2 story | Sarah (PO) |
| 2026-01-08 | 1.1 | Implementation complete | Dev Agent |

---

## Dev Agent Record

### Implementation Summary

**Date:** 2026-01-08

**Files Created:**
- `src/lib/access-control.ts` - Centralized access control logic with tier system
- `src/components/gates/LoginGate.tsx` - Attractive login gate UI for protected spreads
- `src/components/settings/SpreadAccessSection.tsx` - Settings section showing spread access
- `tests/unit/access-control.test.ts` - 37 unit tests for access control

**Files Modified:**
- `src/lib/analytics/events.ts` - Added gate conversion events
- `src/components/settings/index.ts` - Export SpreadAccessSection
- `src/app/settings/page.tsx` - Integrated SpreadAccessSection

**Key Features:**
1. **3-Tier Access System:** guest, free, premium
2. **Spread Access Matrix:** Centralized config for all 8 spreads (5 available, 3 future)
3. **LoginGate Component:** Beautiful UI showing benefits and CTAs
4. **SpreadAccessSection:** Settings page shows user's available spreads
5. **Future-Proof:** Ready for Premium tier gating (Phase 3)
6. **Analytics:** Tracks gate_shown, signup_from_gate, gate_conversion

**Access Matrix:**
| Spread | Guest | Free | Premium |
|--------|-------|------|---------|
| Daily | ✅ | ✅ | ✅ |
| 3-Card | ✅ | ✅ | ✅ |
| Love | ❌ | ✅ | ✅ |
| Career | ❌ | ✅ | ✅ |
| Yes/No | ❌ | ✅ | ✅ |
| Celtic Cross* | ❌ | ❌ | ✅ |
| Relationship* | ❌ | ❌ | ✅ |
| Career Path* | ❌ | ❌ | ✅ |

*Future spreads (not yet available)

**Test Results:**
- 37 unit tests passing for access control logic

