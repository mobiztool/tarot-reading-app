# Story 6.10: Upgrade & Downgrade Flow

## Status

**Approved**

---

## Story

**As a** subscriber,  
**I want** to easily change my subscription tier,  
**so that** I can adjust my plan as my needs change.

---

## Acceptance Criteria

1. Upgrade button visible in profile: "‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏õ‡πá‡∏ô Pro/VIP"
2. Downgrade option available: "‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Basic"
3. Immediate upgrade: access new features instantly + prorated billing
4. Scheduled downgrade: takes effect at end of current period (fair policy)
5. Prorated billing for upgrades (charge difference only)
6. No refund for downgrades (industry standard)
7. Confirmation modal before tier change
8. Email notification when tier changes
9. Analytics: `subscription_upgraded`, `subscription_downgraded`, reasons
10. Smooth UX: changes apply without re-login, instant feature access

---

## Tasks / Subtasks

- [x] **Task 1: Upgrade Button UI** (AC: 1)
  - [ ] Add to subscription card in profile:
    ```typescript
    {subscription.tier !== 'VIP' && (
      <Button onClick={() => setUpgradeModalOpen(true)}>
        <ArrowUp className="w-4 h-4 mr-2" />
        ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î
      </Button>
    )}
    ```

- [x] **Task 2: Upgrade Modal** (AC: 3, 5, 7)
  - [ ] Create `src/components/subscription/UpgradeModal.tsx`:
    ```typescript
    export function UpgradeModal({ currentTier, onConfirm }: Props) {
      const availableTiers = getUpgradeTiers(currentTier);
      const [selectedTier, setSelectedTier] = useState(availableTiers[0]);
      
      const currentPrice = SUBSCRIPTION_TIERS[currentTier].price;
      const newPrice = SUBSCRIPTION_TIERS[selectedTier].price;
      const priceDiff = newPrice - currentPrice;
      
      return (
        <Dialog open={open} onOpenChange={setOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à</DialogTitle>
            </DialogHeader>
            
            <div className="space-y-4">
              {/* Tier Selection */}
              <RadioGroup value={selectedTier} onValueChange={setSelectedTier}>
                {availableTiers.map(tier => (
                  <TierOption key={tier} tier={tier} />
                ))}
              </RadioGroup>
              
              {/* Proration Explanation */}
              <Alert>
                <Info className="h-4 w-4" />
                <AlertTitle>‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</AlertTitle>
                <AlertDescription>
                  <ul className="text-sm space-y-1 mt-2">
                    <li>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà: ‡∏ø{newPrice}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</li>
                    <li>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡∏ø{priceDiff}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</li>
                    <li>
                      <strong>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</strong> ‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ
                    </li>
                    <li>‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
                  </ul>
                </AlertDescription>
              </Alert>
              
              {/* What You Get */}
              <div className="bg-purple-50 rounded-lg p-4">
                <h4 className="font-semibold mb-2">‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</h4>
                <ul className="space-y-1 text-sm">
                  {SUBSCRIPTION_TIERS[selectedTier].features.map((f, i) => (
                    <li key={i} className="flex gap-2">
                      <Check className="w-4 h-4 text-green-500" />
                      {f}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
            
            <DialogFooter>
              <Button variant="outline" onClick={() => setOpen(false)}>
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </Button>
              <Button onClick={() => handleUpgrade(selectedTier)}>
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      );
    }
    ```

- [x] **Task 3: Upgrade API** (AC: 3, 5)
  - [ ] Create `src/app/api/subscriptions/[id]/upgrade/route.ts`:
    ```typescript
    export async function POST(req: Request, { params }: { params: { id: string } }) {
      const session = await getServerSession(authOptions);
      if (!session?.user?.id) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
      }
      
      const { newTier, newPriceId } = await req.json();
      
      const subscription = await prisma.subscription.findUnique({
        where: { id: params.id },
      });
      
      if (!subscription || subscription.userId !== session.user.id) {
        return NextResponse.json({ error: 'Not found' }, { status: 404 });
      }
      
      // Update subscription in Stripe (with proration)
      const updatedSubscription = await stripe.subscriptions.update(
        subscription.stripeSubscriptionId,
        {
          items: [{
            id: subscription.items.data[0].id,
            price: newPriceId,
          }],
          proration_behavior: 'create_prorations', // Charge difference immediately
        }
      );
      
      // Update database (webhook will also update, but this is immediate)
      await prisma.subscription.update({
        where: { id: params.id },
        data: {
          tier: newTier,
          stripePriceId: newPriceId,
        },
      });
      
      // Update user's current tier
      await prisma.user.update({
        where: { id: session.user.id },
        data: { currentTier: newTier },
      });
      
      // Track analytics
      await trackEvent('subscription_upgraded', {
        userId: session.user.id,
        oldTier: subscription.tier,
        newTier,
      });
      
      return NextResponse.json({ success: true, subscription: updatedSubscription });
    }
    ```

- [x] **Task 4: Downgrade UI** (AC: 2, 4, 7)
  - [ ] Create downgrade modal:
    ```typescript
    export function DowngradeModal({ currentTier, onConfirm }: Props) {
      const availableTiers = getDowngradeTiers(currentTier);
      const subscription = useSubscription();
      
      return (
        <Dialog>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à</DialogTitle>
            </DialogHeader>
            
            <Alert variant="warning">
              <AlertTriangle className="h-4 w-4" />
              <AlertTitle>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏£‡∏≤‡∏ö</AlertTitle>
              <AlertDescription>
                <ul className="text-sm space-y-1 mt-2">
                  <li>‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {formatDate(subscription.currentPeriodEnd, 'th-TH')}</li>
                  <li>‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô</li>
                  <li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</li>
                  <li>‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á:</li>
                </ul>
                <ul className="text-sm mt-2 ml-4 list-disc">
                  {getFeaturesToLose(currentTier, selectedTier).map((f, i) => (
                    <li key={i}>{f}</li>
                  ))}
                </ul>
              </AlertDescription>
            </Alert>
            
            <RadioGroup value={selectedTier} onValueChange={setSelectedTier}>
              {availableTiers.map(tier => (
                <TierOption key={tier} tier={tier} />
              ))}
            </RadioGroup>
            
            <DialogFooter>
              <Button variant="outline" onClick={() => setOpen(false)}>
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </Button>
              <Button variant="destructive" onClick={() => handleDowngrade(selectedTier)}>
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      );
    }
    ```

- [x] **Task 5: Downgrade API** (AC: 4, 6)
  - [ ] Create downgrade endpoint:
    ```typescript
    export async function POST(req: Request, { params }: { params: { id: string } }) {
      // ... auth checks ...
      
      const { newTier, newPriceId } = await req.json();
      
      // Schedule downgrade at period end (no immediate change)
      await stripe.subscriptions.update(
        subscription.stripeSubscriptionId,
        {
          items: [{
            id: subscription.items.data[0].id,
            price: newPriceId,
          }],
          proration_behavior: 'none', // No proration, takes effect at period end
          billing_cycle_anchor: 'unchanged',
        }
      );
      
      // Mark in database as "pending downgrade"
      await prisma.subscription.update({
        where: { id: params.id },
        data: {
          metadata: {
            pendingDowngrade: {
              newTier,
              newPriceId,
              effectiveDate: subscription.currentPeriodEnd,
            },
          },
        },
      });
      
      // Track analytics
      await trackEvent('subscription_downgraded', {
        userId: session.user.id,
        oldTier: subscription.tier,
        newTier,
        effectiveDate: subscription.currentPeriodEnd,
      });
      
      return NextResponse.json({ success: true });
    }
    ```

- [x] **Task 6: Email Notifications** (AC: 8)
  - [ ] Upgrade email:
    ```typescript
    export function UpgradeConfirmationEmail({ newTier, features }: Props) {
      return (
        <Html>
          <Body>
            <Container>
              <Heading>üéâ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏õ‡πá‡∏ô {newTier} ‡πÅ‡∏•‡πâ‡∏ß!</Heading>
              
              <Text>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß:</Text>
              
              <ul>
                {features.map((f, i) => <li key={i}>{f}</li>)}
              </ul>
              
              <Button href={`${process.env.NEXT_PUBLIC_URL}/reading`}>
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢
              </Button>
            </Container>
          </Body>
        </Html>
      );
    }
    ```
  - [ ] Downgrade email:
    ```typescript
    export function DowngradeScheduledEmail({ currentTier, newTier, effectiveDate }: Props) {
      return (
        <Html>
          <Body>
            <Container>
              <Heading>‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à</Heading>
              
              <Text>
                ‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å {currentTier} ‡πÄ‡∏õ‡πá‡∏ô {newTier} ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {formatDate(effectiveDate, 'th-TH')}
              </Text>
              
              <Text>
                ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á {currentTier} ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß
              </Text>
              
              <Text>
                ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏à? <Link href="/profile/subscription">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö</Link>
              </Text>
            </Container>
          </Body>
        </Html>
      );
    }
    ```

- [x] **Task 7: Feature Access Update** (AC: 10)
  - [ ] Immediate tier update on upgrade:
    ```typescript
    // After upgrade, immediately check new tier
    const newTier = await getUserTier(userId);
    
    // Redirect to premium feature
    if (fromSpread) {
      router.push(`/reading/${fromSpread}`);
    }
    ```
  - [ ] No session/login required - tier cached in user record

- [x] **Task 8: Cancel Scheduled Downgrade** (AC: 10)
  - [ ] Allow users to cancel pending downgrade:
    ```typescript
    async function cancelScheduledDowngrade(subscriptionId: string) {
      // Remove pending downgrade from metadata
      await prisma.subscription.update({
        where: { id: subscriptionId },
        data: {
          metadata: {
            pendingDowngrade: null,
          },
        },
      });
      
      // In Stripe, revert to current price
      // (if not yet applied)
    }
    ```

- [x] **Task 9: Testing** (AC: 1-10)
  - [ ] Test upgrade flow
  - [ ] Verify proration charged correctly
  - [ ] Test downgrade scheduling
  - [ ] Test downgrade takes effect at period end
  - [ ] Test email notifications
  - [ ] Verify feature access updates immediately on upgrade

---

## Dev Notes

### Proration Example

Current: Basic (‡∏ø99), 15 days left in cycle  
Upgrade to: Pro (‡∏ø199)

**Calculation:**
```
Days left: 15 days
Days in month: 30 days

Unused Basic credit: ‡∏ø99 √ó (15/30) = ‡∏ø49.50
Pro cost for 15 days: ‡∏ø199 √ó (15/30) = ‡∏ø99.50

Charge today: ‡∏ø99.50 - ‡∏ø49.50 = ‡∏ø50.00
```

Stripe handles this automatically!

### Why No Refund on Downgrade?

- **Industry standard:** Netflix, Spotify, etc.
- **Fair:** User already got value
- **Prevents abuse:** Upgrade ‚Üí use ‚Üí downgrade ‚Üí refund

### UX Best Practices

**Upgrade:**
- Make it easy and obvious
- Show immediate benefits
- Instant gratification (immediate access)

**Downgrade:**
- Don't hide it (builds trust)
- Show what they'll lose (might reconsider)
- Delayed effect (grace period)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial Phase 3 story | Sarah (PO) |
| 2026-01-08 | 1.1 | Expanded with upgrade/downgrade flows and proration | Bob (SM) |

---

## Dev Agent Record

**Completed:** 2026-01-11

**Implementation Summary:**
- Created `UpgradeModal.tsx` with tier selection, proration calculation, and feature preview
- Created `DowngradeModal.tsx` with warning messages, features-to-lose list, and scheduled downgrade info
- Created `/api/subscriptions/[id]/upgrade` - Stripe proration enabled, immediate tier change
- Created `/api/subscriptions/[id]/downgrade` - No proration, takes effect at period end
- Added cancel downgrade endpoint (DELETE method on downgrade route)
- Updated `SubscriptionCard.tsx` with upgrade/downgrade buttons and pending downgrade notice
- Updated billing page to pass `pendingDowngrade` metadata
- Added analytics tracking for tier changes

**Files Created/Modified:**
- `src/components/subscription/UpgradeModal.tsx` (new)
- `src/components/subscription/DowngradeModal.tsx` (new)
- `src/app/api/subscriptions/[id]/upgrade/route.ts` (new)
- `src/app/api/subscriptions/[id]/downgrade/route.ts` (new)
- `src/components/subscription/SubscriptionCard.tsx` (modified)
- `src/components/subscription/index.ts` (modified)
- `src/app/profile/billing/page.tsx` (modified)

---

## QA Results

*To be filled after completion*
