# Story 5.7: Spread Usage Analytics

## Status

**Ready for Review** ✅

---

## Story

**As a** product manager,  
**I want** to track spread usage and conversions,  
**so that** I can optimize for user engagement and improve the product.

---

## Acceptance Criteria

1. Analytics events tracked for all 5 spreads (Daily, 3-Card, Love, Career, Yes/No)
2. Spread popularity metrics dashboard: which spreads are most used
3. Conversion funnel tracking: spread interest → login prompt → signup → spread usage
4. Retention metrics: do users return? Which spreads drive retention?
5. Time spent per spread type (engagement depth)
6. Completion rate per spread (started vs. completed)
7. Dashboard: spread performance comparison with visualizations
8. Cohort analysis: which spread drove user signup
9. Export capability: download analytics data as CSV
10. Real-time tracking: events appear in analytics within 24 hours

---

## Tasks / Subtasks

- [x] **Task 1: Spread Event Tracking** (AC: 1, 6) ✅
  - [x] Track events for each spread type:
    - `spread_started` (spread_type, user_id, timestamp)
    - `spread_completed` (spread_type, user_id, reading_id, timestamp)
    - `spread_abandoned` (spread_type, user_id, step, timestamp)
  - [x] Track at key milestones:
    - Spread selection page view
    - Question input (if applicable)
    - Card draw initiated
    - Result page viewed
  - [x] Include metadata:
    - User tier (guest, logged-in, premium future)
    - Device type (mobile, desktop, tablet)
    - Spread type
    - Session ID

- [x] **Task 2: Conversion Funnel Tracking** (AC: 3, 8) ✅
  - [x] Track complete funnel:
    1. `spread_gate_shown` (spread_type, user_status: guest)
    2. `login_prompt_clicked` (from_spread: spread_type)
    3. `signup_completed` (signup_trigger: spread_type)
    4. `spread_completed` (spread_type, user_id)
  - [x] Attribution: Link signup to triggering spread
  - [x] Funnel drop-off analysis: where do users leave?

- [x] **Task 3: Popularity & Engagement Metrics** (AC: 2, 5) ✅
  - [x] **Popularity metrics:**
    - Total readings per spread type (daily, weekly, monthly)
    - Unique users per spread
    - Repeat usage rate per spread
  - [x] **Engagement metrics:**
    - Average time on result page
    - Time spent per spread (start to completion)
    - Question length (for spreads with questions)

- [x] **Task 4: Retention Analysis** (AC: 4) ✅
  - [x] Track user return behavior:
    - Day 1, Day 7, Day 30 retention by first spread used
    - Spread diversity: do users try multiple spreads?
    - Favorite spread per user (most used)
  - [x] Cohort retention: users who signed up via Love spread vs Career spread

- [x] **Task 5: Analytics Dashboard** (AC: 7, 9) ✅
  - [x] Create dashboard page: `/admin/analytics/spreads` (admin only)
  - [x] **Dashboard sections:**
    - **Overview:** Total readings, active users, completion rate
    - **Spread Comparison:** Bar chart of readings per spread type
    - **Conversion Funnel:** Visualization of gate → signup → usage
    - **Retention Table:** Cohort retention by signup spread
    - **Time Metrics:** Average time spent per spread
  - [x] Date range selector (Last 7 days, 30 days, 90 days, All time)
  - [x] Export button: Download as CSV
  - [x] Real-time refresh: Auto-update every 5 minutes

- [x] **Task 6: Integration with Existing Analytics** (AC: 10) ✅
  - [x] Integrate with GA4 (gtag events)
  - [x] Custom events in GA4:
    - `spread_started`, `spread_completed`
    - Custom dimensions: spread_type, user_tier
  - [x] Server-side tracking for accuracy
  - [x] Database: Log to `analytics_events` table for internal queries

- [x] **Task 7: Admin Access Control** ✅
  - [x] Protect `/admin/*` routes in middleware
  - [x] Require admin role
  - [x] API-level admin check in metrics endpoint

- [x] **Task 8: Testing** (AC: 1-10) ✅
  - [x] 21 unit tests passing
  - [x] Test event tracking structure
  - [x] Test device detection
  - [x] Test metrics calculations

---

## Dev Notes

### Analytics Architecture

```
┌─────────────────────────────────────────────────────────┐
│ User Actions (Spread Usage)                             │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ Client-Side Tracking (analytics/trackEvent)             │
│  - GA4 events                                            │
│  - Server API call                                       │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ Server-Side Logging (API route)                         │
│  POST /api/analytics/event                              │
│  - Validate & enrich event                              │
│  - Save to database                                      │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ Database (analytics_events table)                       │
│  - event_type, spread_type, user_id, timestamp          │
│  - metadata (device, session_id, etc.)                  │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ Analytics Dashboard (Admin UI)                          │
│  - Query database for metrics                           │
│  - Visualize with charts                                │
│  - Export CSV                                            │
└─────────────────────────────────────────────────────────┘
```

### Database Schema Addition

```prisma
model AnalyticsEvent {
  id          String   @id @default(cuid())
  eventType   String   // spread_started, spread_completed, etc.
  spreadType  String?  // daily, three_card, love_relationships, etc.
  userId      String?  // null for guest events
  user        User?    @relation(fields: [userId], references: [id])
  readingId   String?  // link to reading if completed
  reading     Reading? @relation(fields: [readingId], references: [id])
  
  // Metadata
  deviceType  String?  // mobile, desktop, tablet
  sessionId   String?
  metadata    Json?    // flexible for additional data
  
  timestamp   DateTime @default(now())
  
  @@index([eventType, spreadType, timestamp])
  @@index([userId, timestamp])
  @@index([spreadType, timestamp])
}
```

### Key Metrics Definitions

**Popularity:**
- **Total Readings:** Count of `spread_completed` events per spread_type
- **Unique Users:** Distinct user_id per spread_type
- **Repeat Rate:** Users with >1 reading of same spread / Total users

**Conversion:**
- **Gate Conversion:** (login_prompt_clicked / spread_gate_shown) × 100
- **Signup Conversion:** (signup_completed / login_prompt_clicked) × 100
- **Usage Conversion:** (spread_completed / signup_completed) × 100
- **Overall Funnel:** (spread_completed / spread_gate_shown) × 100

**Engagement:**
- **Completion Rate:** (spread_completed / spread_started) × 100
- **Avg Time:** Average (completion_timestamp - start_timestamp)
- **Abandonment Rate:** (spread_abandoned / spread_started) × 100

**Retention:**
- **D1 Retention:** Users who return within 24h of signup
- **D7 Retention:** Users who return within 7 days
- **D30 Retention:** Users who return within 30 days

### Visualization Examples

**Spread Comparison Chart:**
```
Love:     ████████████████████████ 2,400 readings
Career:   ████████████████████ 2,000 readings
Yes/No:   ███████████████ 1,500 readings
3-Card:   ████████████ 1,200 readings
Daily:    ████████ 800 readings
```

**Conversion Funnel:**
```
Gate Shown:       10,000 users (100%)
  ↓ 30%
Login Clicked:    3,000 users (30%)
  ↓ 50%
Signup Complete:  1,500 users (15%)
  ↓ 80%
Spread Complete:  1,200 users (12%)
```

### Integration Points

**From Story 1.3:** Analytics & Monitoring foundation
- GA4 setup already exists
- Reuse event tracking patterns

**From Story 2.12:** User Analytics Metrics
- User-level tracking already implemented
- Extend for spread-specific events

**New in This Story:**
- Spread-specific event taxonomy
- Conversion funnel for spread-driven signups
- Admin dashboard for internal analytics

### Future Enhancements (Out of Scope)

- ~~Question analysis with NLP~~ (removed from AC - too complex for Phase 2)
- A/B testing infrastructure (moved to Epic 6+)
- Predictive analytics (which spread to recommend)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Initial Phase 2 story | Sarah (PO) |
| 2026-01-08 | 1.1 | Expanded with dashboard details and database schema | Bob (SM) |

---

## Dev Agent Record

### Implementation Summary (2026-01-08)

**Files Created:**
1. `src/lib/analytics/spreadAnalytics.ts` - Analytics service with tracking functions
2. `src/app/api/analytics/events/route.ts` - API route for logging events
3. `src/app/api/analytics/metrics/route.ts` - API route for querying metrics
4. `src/app/admin/analytics/spreads/page.tsx` - Analytics dashboard UI
5. `src/app/admin/layout.tsx` - Admin layout with noindex
6. `prisma/migrations/add_analytics_events.sql` - Database migration
7. `tests/unit/spreadAnalytics.test.ts` - 21 unit tests

**Database Schema:**
- Added `AnalyticsEvent` model with 13 event types
- Added `AnalyticsEventType` enum
- Added `DeviceType` enum
- Proper indexes for efficient queries

**Dashboard Features:**
- Overview cards (readings, users, completion, duration)
- Spread comparison bar chart
- Conversion funnel visualization
- Retention table with D1/D7/D30
- Date range selector
- CSV export
- Auto-refresh every 5 minutes

**Security:**
- Admin routes protected in middleware
- Admin role check in API endpoints
- RBAC via user_metadata.role or email domain

---

## QA Results

*To be filled after completion*
