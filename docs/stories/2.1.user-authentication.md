# Story 2.1: User Authentication with Supabase Auth

## Status

**Approved**

---

## Story

**As a** new user,  
**I want** to sign up for an account easily using email or social login,  
**so that** I can save my readings and access them later from any device.

---

## Acceptance Criteria

1. Supabase Auth configured with email/password authentication enabled
2. Sign up page (`/auth/signup`) created with form: email, password, confirm password, terms acceptance checkbox
3. Email validation: proper format, not already registered
4. Password validation: minimum 8 characters, at least 1 uppercase, 1 lowercase, 1 number
5. Password strength indicator displayed (weak/medium/strong)
6. "Sign up with Google" button integrated (Supabase OAuth Google provider)
7. "Sign up with Facebook" button integrated (Supabase OAuth Facebook provider)
8. Email verification: Supabase sends confirmation email, user must verify before full access
9. Sign up success: user redirected to profile page or previous page they were on
10. Error handling: display clear messages for duplicate email, weak password, network errors
11. Terms of service and privacy policy links included (placeholder pages)
12. PDPA compliance: consent checkbox for data collection
13. Analytics tracked: `signup_started`, `signup_completed`, `signup_method` (email/google/facebook)

---

## Tasks / Subtasks

- [ ] **Task 1: Configure Supabase Auth** (AC: 1)
  - [ ] Enable Email/Password authentication in Supabase dashboard
  - [ ] Configure auth settings: confirmation required, password requirements
  - [ ] Set redirect URLs: `http://localhost:3000/auth/callback` (dev), production URL
  - [ ] Enable Google OAuth provider with credentials
  - [ ] Enable Facebook OAuth provider with credentials
  - [ ] Test auth configuration in Supabase dashboard
  - [ ] Document auth setup in README

- [ ] **Task 2: Install Supabase Auth Client** (AC: 1)
  - [ ] Install packages: `pnpm add @supabase/supabase-js @supabase/auth-helpers-nextjs`
  - [ ] Create `src/lib/supabase/client.ts` for client-side auth
  - [ ] Create `src/lib/supabase/server.ts` for server-side auth
  - [ ] Configure Supabase client with environment variables
  - [ ] Add to `.env.local`:
    ```
    NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
    NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
    ```

- [ ] **Task 3: Create Signup Page** (AC: 2)
  - [ ] Create `src/app/auth/signup/page.tsx`
  - [ ] Add metadata for SEO
  - [ ] Create form with React Hook Form + Zod validation
  - [ ] Form fields:
    - Email input (type="email")
    - Password input (type="password", toggle visibility)
    - Confirm password input
    - Terms acceptance checkbox
    - PDPA consent checkbox
  - [ ] Style with dark theme, mystical aesthetic
  - [ ] Mobile responsive layout

- [ ] **Task 4: Implement Email/Password Validation** (AC: 3, 4)
  - [ ] Create Zod schema `src/lib/validation/auth.ts`:
    ```typescript
    export const signupSchema = z
      .object({
        email: z.string().email('Invalid email format'),
        password: z
          .string()
          .min(8, 'Password must be at least 8 characters')
          .regex(/[A-Z]/, 'Must contain uppercase letter')
          .regex(/[a-z]/, 'Must contain lowercase letter')
          .regex(/[0-9]/, 'Must contain number'),
        confirmPassword: z.string(),
        termsAccepted: z.boolean().refine((val) => val === true, 'Must accept terms'),
      })
      .refine((data) => data.password === data.confirmPassword, {
        message: "Passwords don't match",
        path: ['confirmPassword'],
      });
    ```
  - [ ] Apply validation to form
  - [ ] Show error messages inline

- [ ] **Task 5: Add Password Strength Indicator** (AC: 5)
  - [ ] Create `src/components/auth/PasswordStrength.tsx`
  - [ ] Calculate strength based on:
    - Length (8+ chars)
    - Character variety (upper, lower, number, special)
    - Common password check (optional)
  - [ ] Display indicator:
    - Weak: red bar, 1/4 filled
    - Medium: yellow bar, 2/4 filled
    - Strong: green bar, 4/4 filled
  - [ ] Show helpful tips: "Add uppercase letter", "Add number"

- [ ] **Task 6: Implement Email/Password Signup** (AC: 2, 8, 9)
  - [ ] Create signup handler:
    ```typescript
    const handleEmailSignup = async (data: SignupFormData) => {
      const { data: authData, error } = await supabase.auth.signUp({
        email: data.email,
        password: data.password,
        options: {
          emailRedirectTo: `${window.location.origin}/auth/callback`,
        },
      });

      if (error) throw error;

      // Show success message: check email for verification
      router.push('/auth/verify-email');
    };
    ```
  - [ ] Handle success: redirect to verification page
  - [ ] Handle errors: show user-friendly messages

- [ ] **Task 7: Create Email Verification Page** (AC: 8)
  - [ ] Create `src/app/auth/verify-email/page.tsx`
  - [ ] Show message: "Check your email to verify your account"
  - [ ] Display: email icon, instructions, resend link
  - [ ] Resend verification email functionality
  - [ ] Style consistent with signup page

- [ ] **Task 8: Create Auth Callback Handler** (AC: 8, 9)
  - [ ] Create `src/app/auth/callback/route.ts`
  - [ ] Handle email verification callback
  - [ ] Handle OAuth callbacks (Google, Facebook)
  - [ ] Create user record in database
  - [ ] Redirect to intended page or profile
  - [ ] Example:
    ```typescript
    export async function GET(request: NextRequest) {
      const { searchParams } = new URL(request.url);
      const code = searchParams.get('code');

      if (code) {
        await supabase.auth.exchangeCodeForSession(code);
      }

      return NextResponse.redirect('/profile');
    }
    ```

- [ ] **Task 9: Implement Google OAuth** (AC: 6)
  - [ ] Add "Sign up with Google" button
  - [ ] Use Google icon from Lucide React
  - [ ] Implement click handler:
    ```typescript
    const handleGoogleSignup = async () => {
      await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: `${window.location.origin}/auth/callback`,
        },
      });
    };
    ```
  - [ ] Test OAuth flow in browser
  - [ ] Verify user data saved to database

- [ ] **Task 10: Implement Facebook OAuth** (AC: 7)
  - [ ] Add "Sign up with Facebook" button
  - [ ] Use Facebook icon
  - [ ] Implement similar to Google OAuth
  - [ ] Test Facebook login flow
  - [ ] Handle Facebook-specific data (profile picture, name)

- [ ] **Task 11: Error Handling** (AC: 10)
  - [ ] Create error message component
  - [ ] Handle common errors:
    - Duplicate email: "Email already registered"
    - Weak password: "Password doesn't meet requirements"
    - Network error: "Connection failed, please try again"
    - Invalid email format: "Please enter valid email"
  - [ ] Show errors in toast or inline
  - [ ] Log errors to Sentry
  - [ ] Provide recovery actions

- [ ] **Task 12: Add Terms & Privacy Links** (AC: 11)
  - [ ] Create placeholder pages:
    - `src/app/terms/page.tsx`
    - `src/app/privacy/page.tsx`
  - [ ] Add links to signup form
  - [ ] Style links: underlined, purple color
  - [ ] Open in new tab: `target="_blank"`

- [ ] **Task 13: PDPA Compliance** (AC: 12)
  - [ ] Add PDPA consent checkbox:
        "I consent to the collection and use of my data"
  - [ ] Make checkbox required
  - [ ] Link to privacy policy
  - [ ] Store consent in user metadata
  - [ ] Document PDPA compliance

- [ ] **Task 14: Analytics Tracking** (AC: 13)
  - [ ] Track events:
    - `signup_started`: When user lands on signup page
    - `signup_method_selected`: When user clicks Google/Facebook
    - `signup_completed`: When signup succeeds
  - [ ] Include properties:
    ```typescript
    trackEvent('signup_completed', {
      signup_method: 'email', // or 'google', 'facebook'
      email_verified: false,
      timestamp: Date.now(),
    });
    ```
  - [ ] Verify events in GA4

- [ ] **Task 15: Create Auth Context/Hook** (AC: 9)
  - [ ] Create `src/lib/hooks/useAuth.ts`:
    ```typescript
    export function useAuth() {
      const [user, setUser] = useState<User | null>(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        // Get initial session
        supabase.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setLoading(false);
        });

        // Listen to auth changes
        const {
          data: { subscription },
        } = supabase.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user ?? null);
        });

        return () => subscription.unsubscribe();
      }, []);

      return { user, loading, signUp, signIn, signOut };
    }
    ```
  - [ ] Export from `src/lib/hooks/index.ts`

- [ ] **Task 16: Loading States** (AC: 9)
  - [ ] Show loading spinner during signup
  - [ ] Disable form inputs while submitting
  - [ ] Disable buttons with loading text: "Creating account..."
  - [ ] Show skeleton for OAuth buttons if needed

- [ ] **Task 17: Testing** (AC: 1-13)
  - [ ] Unit tests: validation schemas
  - [ ] Integration tests: signup API
  - [ ] E2E tests:
    ```typescript
    test('complete email signup flow', async ({ page }) => {
      await page.goto('/auth/signup');
      await page.fill('[name="email"]', 'test@example.com');
      await page.fill('[name="password"]', 'Password123');
      await page.fill('[name="confirmPassword"]', 'Password123');
      await page.check('[name="termsAccepted"]');
      await page.click('button[type="submit"]');
      await expect(page).toHaveURL('/auth/verify-email');
    });
    ```
  - [ ] Test OAuth flows manually
  - [ ] Test error scenarios

- [ ] **Task 18: Documentation** (AC: 1-13)
  - [ ] Document Supabase Auth setup
  - [ ] Document OAuth provider configuration
  - [ ] Document environment variables
  - [ ] Add troubleshooting guide
  - [ ] Commit: "feat: Add user signup with Supabase Auth"

---

## Dev Notes

### Previous Story Insights

**From Story 1.1 (Project Setup):**

- Environment variables configured
- Next.js 14 App Router ready

**From Story 1.3 (Analytics):**

- Analytics tracking hooks available
- useAnalytics hook ready

**Integration Points:**

- Auth state affects navigation (Story 2.10)
- User ID links to readings (Story 2.5)
- Profile page shows after signup (Story 2.4)

---

### Tech Stack (Story 2.1 Specific)

**Authentication:**

- **Supabase Auth**: JWT-based auth with OAuth providers [Source: architecture/tech-stack.md]
- **@supabase/auth-helpers-nextjs**: Next.js integration helpers
- **React Hook Form + Zod**: Form handling and validation [Source: architecture/tech-stack.md]

**OAuth Providers:**

- Google OAuth
- Facebook OAuth
- Email/Password (built-in)

---

### Supabase Auth Configuration

**Client Setup:**

```typescript
// lib/supabase/client.ts
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';

export const supabase = createClientComponentClient();
```

**Server Setup:**

```typescript
// lib/supabase/server.ts
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';

export const createClient = () => {
  const cookieStore = cookies();
  return createServerComponentClient({ cookies: () => cookieStore });
};
```

[Source: architecture/backend-architecture.md]

---

### Form Validation Schema

```typescript
// lib/validation/auth.ts
import { z } from 'zod';

export const signupSchema = z
  .object({
    email: z.string().min(1, 'Email is required').email('Invalid email format'),

    password: z
      .string()
      .min(8, 'Password must be at least 8 characters')
      .regex(/[A-Z]/, 'Must contain at least one uppercase letter')
      .regex(/[a-z]/, 'Must contain at least one lowercase letter')
      .regex(/[0-9]/, 'Must contain at least one number'),

    confirmPassword: z.string(),

    termsAccepted: z
      .boolean()
      .refine((val) => val === true, 'You must accept the terms and conditions'),

    pdpaConsent: z.boolean().refine((val) => val === true, 'You must consent to data collection'),
  })
  .refine((data) => data.password === data.confirmPassword, {
    message: "Passwords don't match",
    path: ['confirmPassword'],
  });

export type SignupFormData = z.infer<typeof signupSchema>;
```

---

### Password Strength Calculation

```typescript
// components/auth/PasswordStrength.tsx
export function calculatePasswordStrength(password: string): {
  score: number;
  label: 'weak' | 'medium' | 'strong';
  color: string;
} {
  let score = 0;

  if (password.length >= 8) score++;
  if (password.length >= 12) score++;
  if (/[A-Z]/.test(password)) score++;
  if (/[a-z]/.test(password)) score++;
  if (/[0-9]/.test(password)) score++;
  if (/[^A-Za-z0-9]/.test(password)) score++;

  if (score <= 2) return { score, label: 'weak', color: 'red' };
  if (score <= 4) return { score, label: 'medium', color: 'yellow' };
  return { score, label: 'strong', color: 'green' };
}
```

---

### OAuth Configuration

**Supabase Dashboard Setup:**

1. Go to Authentication â†’ Providers
2. Enable Google:
   - Client ID from Google Cloud Console
   - Client Secret
   - Authorized redirect URI: `https://xxx.supabase.co/auth/v1/callback`
3. Enable Facebook:
   - App ID from Facebook Developers
   - App Secret
   - Authorized redirect URI

**Environment Variables:**

```bash
# Public (already have from Story 1.2)
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
```

---

### Testing Strategy

**Unit Tests:**

- Validation schemas
- Password strength calculation
- Error message generation

**Integration Tests:**

- Supabase auth API calls
- Database user creation
- OAuth provider integration

**E2E Tests:**

- Complete signup flow
- Email verification
- OAuth flows (Google, Facebook)
- Error handling

**Manual Testing:**

- Test with real email
- Verify email arrives
- Test OAuth with real accounts
- Test error states

**Coverage Target:**

- Auth components: >85%
- Validation logic: 100%

[Source: architecture/testing-strategy.md]

---

### Notes

**Important:**

- Email verification required for security
- OAuth simplifies signup process
- PDPA compliance critical for Thai users
- Clear error messages improve UX

**Dependencies:**

- **Story 1.1 completed**: Project setup
- **Story 1.2 completed**: Database ready
- **Story 1.3 completed**: Analytics ready
- Supabase project created

**Blockers:**

- Need Google OAuth credentials
- Need Facebook OAuth credentials
- Both available from cloud consoles

**Future Considerations:**

- Apple Sign In (iOS users)
- Line Login (popular in Thailand)
- Magic link login (passwordless)
- Two-factor authentication (2FA)

---

## Change Log

| Date       | Version | Description            | Author           |
| ---------- | ------- | ---------------------- | ---------------- |
| 2026-01-01 | 1.0     | Initial story creation | Sarah (PO Agent) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_This section will be populated by the QA Agent after story completion._
