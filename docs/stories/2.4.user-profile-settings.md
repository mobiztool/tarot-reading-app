# Story 2.4: User Profile Page & Settings

## Status

**Approved**

---

## Story

**As a** logged-in user,  
**I want** to view and edit my profile information,  
**so that** I can keep my account details up to date.

---

## Acceptance Criteria

1. Profile page (`/profile`) created with user information display
2. Displays: profile picture, name, email, account created date
3. Edit profile form: update name, upload profile picture
4. Profile picture upload: max 2MB, formats JPG/PNG, stored in Supabase Storage
5. Email change: requires re-verification (security measure)
6. Password change: current password, new password, confirm password fields
7. Account deletion option: "Delete my account" button with confirmation modal
8. Account deletion: permanently delete user data, readings, and logout
9. Settings section: email preferences (placeholder for Epic 4)
10. Success messages: "Profile updated successfully"
11. Validation: proper error messages for invalid inputs
12. Mobile responsive: profile page works well on all screen sizes
13. Analytics tracked: `profile_updated`, `account_deleted`

---

## Tasks / Subtasks

- [ ] **Task 1: Create Profile Page** (AC: 1, 2)
  - [ ] Create `src/app/profile/page.tsx`
  - [ ] Protected route (requires authentication)
  - [ ] Fetch user data from Supabase:
    ```typescript
    const {
      data: { user },
    } = await supabase.auth.getUser();
    const { data: profile } = await supabase.from('users').select('*').eq('id', user.id).single();
    ```
  - [ ] Display user information:
    - Profile picture (or placeholder if none)
    - Name
    - Email
    - Member since date
  - [ ] Add edit button to switch to edit mode

- [ ] **Task 2: Profile Picture Display** (AC: 2)
  - [ ] Create `ProfilePicture` component
  - [ ] Show uploaded image or initials avatar
  - [ ] Initials avatar: first letter of name in colored circle
  - [ ] Circular shape with border
  - [ ] Different sizes: small (header), large (profile page)

- [ ] **Task 3: Edit Profile Form** (AC: 3)
  - [ ] Toggle between view and edit modes
  - [ ] Edit form fields:
    - Name input (editable)
    - Email display (read-only, link to change email)
    - Profile picture upload button
  - [ ] Save and Cancel buttons
  - [ ] Validate name: required, 2-50 characters

- [ ] **Task 4: Profile Picture Upload** (AC: 4)
  - [ ] Create file input (hidden, triggered by button)
  - [ ] Validate file:
    - Max size: 2MB
    - Allowed types: image/jpeg, image/png
    - Show error if invalid
  - [ ] Preview image before upload
  - [ ] Upload to Supabase Storage:

    ```typescript
    const file = event.target.files[0];
    const fileExt = file.name.split('.').pop();
    const fileName = `${user.id}-${Date.now()}.${fileExt}`;

    const { data, error } = await supabase.storage.from('avatars').upload(fileName, file, {
      cacheControl: '3600',
      upsert: true,
    });

    // Update user profile with new URL
    const publicURL = supabase.storage.from('avatars').getPublicUrl(fileName).data.publicUrl;
    ```

  - [ ] Update profile with new image URL
  - [ ] Show success message

- [ ] **Task 5: Update Profile Handler** (AC: 3, 10)
  - [ ] Create update handler:
    ```typescript
    const handleUpdateProfile = async (data: ProfileFormData) => {
      const { error } = await supabase
        .from('users')
        .update({
          name: data.name,
          profile_picture_url: data.profilePictureUrl,
        })
        .eq('id', user.id);

      if (error) throw error;

      showToast('Profile updated successfully', 'success');
      trackEvent('profile_updated');
    };
    ```
  - [ ] Handle errors
  - [ ] Show success toast/message
  - [ ] Update UI with new data

- [ ] **Task 6: Email Change Flow** (AC: 5)
  - [ ] Add "Change Email" button/link
  - [ ] Show change email form in modal or separate section
  - [ ] Input: new email, current password (for security)
  - [ ] Use Supabase Auth API:
    ```typescript
    const { data, error } = await supabase.auth.updateUser({
      email: newEmail,
    });
    ```
  - [ ] Supabase sends verification email to new address
  - [ ] Show message: "Verification email sent to new address"
  - [ ] Email only updates after user clicks verification link

- [ ] **Task 7: Password Change Form** (AC: 6)
  - [ ] Add "Change Password" section
  - [ ] Form fields:
    - Current password (verify user identity)
    - New password
    - Confirm new password
  - [ ] Validate new password (same rules as signup)
  - [ ] Show password strength indicator
  - [ ] Implementation:
    ```typescript
    const handleChangePassword = async (data: ChangePasswordData) => {
      // First verify current password by attempting to sign in
      const { error: verifyError } = await supabase.auth.signInWithPassword({
        email: user.email,
        password: data.currentPassword,
      });

      if (verifyError) {
        throw new Error('Current password incorrect');
      }

      // Update to new password
      const { error } = await supabase.auth.updateUser({
        password: data.newPassword,
      });

      if (error) throw error;

      showToast('Password changed successfully');
    };
    ```

- [ ] **Task 8: Account Deletion** (AC: 7, 8)
  - [ ] Add "Delete Account" button in danger zone section
  - [ ] Style with warning color (red)
  - [ ] Click shows confirmation modal:
    - Warning message: "This action cannot be undone"
    - List what will be deleted: "All readings, profile data"
    - Input: type "DELETE" to confirm
    - Final confirmation checkbox
  - [ ] Delete handler:
    ```typescript
    const handleDeleteAccount = async () => {
      // Delete user data (handled by Supabase cascade delete)
      const { error } = await supabase.rpc('delete_user', {
        user_id: user.id,
      });

      if (error) throw error;

      // Logout and redirect
      await supabase.auth.signOut();
      router.push('/');
      trackEvent('account_deleted');
    };
    ```
  - [ ] Create Supabase function for complete user deletion

- [ ] **Task 9: Settings Section** (AC: 9)
  - [ ] Create settings area on profile page or separate `/settings` page
  - [ ] Email preferences (placeholder):
    - Daily reading reminder checkbox (disabled, "Coming soon")
    - Weekly summary checkbox (disabled, "Coming soon")
  - [ ] Display: "More settings coming in future updates"
  - [ ] Prepare structure for Epic 4 features

- [ ] **Task 10: Form Validation** (AC: 11)
  - [ ] Validate all form inputs:
    - Name: required, 2-50 chars, letters only
    - Email: valid email format
    - Password: same rules as signup
  - [ ] Show errors inline below inputs
  - [ ] Disable submit if validation fails
  - [ ] Clear errors on input change

- [ ] **Task 11: Loading States** (AC: 10)
  - [ ] Show loading spinner while fetching profile
  - [ ] Show skeleton screen for profile data
  - [ ] Disable forms during submission
  - [ ] Button loading states: "Updating...", "Uploading..."

- [ ] **Task 12: Error Handling** (AC: 11)
  - [ ] Handle common errors:
    - Network error: "Connection failed"
    - Upload error: "Failed to upload image"
    - Permission error: "You don't have permission"
    - Validation error: Show specific field errors
  - [ ] Log errors to Sentry
  - [ ] Show recovery actions where possible

- [ ] **Task 13: Analytics Tracking** (AC: 13)
  - [ ] Track events:
    - `profile_viewed`: When profile page loads
    - `profile_updated`:
      ```typescript
      trackEvent('profile_updated', {
        fields_updated: ['name', 'profile_picture'],
      });
      ```
    - `email_change_requested`
    - `password_changed`
    - `account_deleted`:
      ```typescript
      trackEvent('account_deleted', {
        account_age_days: accountAgeDays,
        readings_count: readingsCount,
      });
      ```

- [ ] **Task 14: Mobile Responsive** (AC: 12)
  - [ ] Test on mobile devices
  - [ ] Stack elements vertically on mobile
  - [ ] Large, touch-friendly buttons
  - [ ] Profile picture: smaller on mobile
  - [ ] Forms: full-width inputs
  - [ ] Test on iOS Safari and Chrome Android

- [ ] **Task 15: Testing** (AC: 1-13)
  - [ ] E2E tests:

    ```typescript
    test('update profile name', async ({ page }) => {
      await page.goto('/profile');
      await page.click('button:has-text("Edit Profile")');
      await page.fill('[name="name"]', 'New Name');
      await page.click('button:has-text("Save")');
      await expect(page.locator('text=Profile updated')).toBeVisible();
    });

    test('upload profile picture', async ({ page }) => {
      await page.goto('/profile');
      await page.setInputFiles('input[type="file"]', 'test-avatar.jpg');
      await expect(page.locator('text=Profile updated')).toBeVisible();
    });

    test('delete account', async ({ page }) => {
      await page.goto('/profile');
      await page.click('text=Delete Account');
      await page.fill('[placeholder*="DELETE"]', 'DELETE');
      await page.click('button:has-text("Confirm Delete")');
      await expect(page).toHaveURL('/');
    });
    ```

  - [ ] Test validation errors
  - [ ] Test image upload limits

- [ ] **Task 16: Documentation** (AC: 1-13)
  - [ ] Document profile page features
  - [ ] Document Supabase Storage setup for avatars
  - [ ] Document account deletion process
  - [ ] Commit: "feat: Add user profile page and settings"

---

## Dev Notes

### Previous Story Insights

**From Story 2.1 (Signup):**

- User record created in database
- Profile data structure defined

**From Story 2.2 (Login):**

- User authentication state available
- Protected routes working

**Integration Points:**

- After signup: redirect here (Story 2.1)
- After password reset: redirect here (Story 2.3)
- Profile picture shows in navigation (Story 2.10)

---

### Supabase Storage Setup

**Create Avatars Bucket:**

1. Go to Storage in Supabase dashboard
2. Create new bucket: "avatars"
3. Set as public bucket
4. Configure policies:

   ```sql
   -- Allow authenticated users to upload their own avatar
   CREATE POLICY "Users can upload own avatar"
   ON storage.objects FOR INSERT
   WITH CHECK (
     bucket_id = 'avatars' AND
     auth.uid()::text = (storage.foldername(name))[1]
   );

   -- Anyone can view avatars
   CREATE POLICY "Avatars are publicly accessible"
   ON storage.objects FOR SELECT
   USING (bucket_id = 'avatars');
   ```

**Upload API:**

```typescript
const uploadAvatar = async (file: File) => {
  const fileExt = file.name.split('.').pop();
  const fileName = `${user.id}/${Date.now()}.${fileExt}`;

  const { data, error } = await supabase.storage.from('avatars').upload(fileName, file, {
    cacheControl: '3600',
    upsert: true,
  });

  if (error) throw error;

  const {
    data: { publicUrl },
  } = supabase.storage.from('avatars').getPublicUrl(fileName);

  return publicUrl;
};
```

[Source: architecture/backend-architecture.md]

---

### Account Deletion Function

**Supabase SQL Function:**

```sql
-- Create function to delete user completely
CREATE OR REPLACE FUNCTION delete_user(user_id UUID)
RETURNS void AS $$
BEGIN
  -- Delete from users table (cascade deletes readings)
  DELETE FROM users WHERE id = user_id;

  -- Delete from auth.users (Supabase Auth)
  DELETE FROM auth.users WHERE id = user_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**Call from client:**

```typescript
const { error } = await supabase.rpc('delete_user', {
  user_id: user.id,
});
```

---

### Profile Picture Component

```typescript
// components/profile/ProfilePicture.tsx
interface ProfilePictureProps {
  src?: string | null;
  name?: string;
  size?: 'sm' | 'md' | 'lg';
  editable?: boolean;
  onUpload?: (file: File) => void;
}

export function ProfilePicture({
  src,
  name,
  size = 'md',
  editable = false,
  onUpload
}: ProfilePictureProps) {
  if (src) {
    return (
      <div className={`profile-picture ${size}`}>
        <Image src={src} alt={name || 'Profile'} fill />
        {editable && <EditButton onClick={() => fileInput.click()} />}
      </div>
    );
  }

  // Show initials if no image
  const initials = name?.charAt(0).toUpperCase() || '?';
  return (
    <div className={`profile-avatar ${size}`}>
      <span>{initials}</span>
      {editable && <EditButton />}
    </div>
  );
}
```

---

### Testing Strategy

**Unit Tests:**

- Form validation
- File size/type validation
- Profile update logic

**Integration Tests:**

- Supabase Storage upload
- Profile update API
- Account deletion

**E2E Tests:**

- Update profile name
- Upload profile picture
- Change password
- Delete account

**Manual Testing:**

- Image upload (various sizes and types)
- Error scenarios
- Mobile responsiveness

**Coverage Target:**

- Profile components: >85%
- Upload logic: >90%

[Source: architecture/testing-strategy.md]

---

### Notes

**Important:**

- Profile pictures stored in Supabase Storage
- Email change requires verification
- Account deletion is permanent (warn users!)
- Settings section expandable in Epic 4

**Dependencies:**

- **Story 2.1 completed**: User signup
- **Story 2.2 completed**: User login
- **Story 2.5 completed**: Users table schema

**Blockers:**

- None

**Future Considerations:**

- Profile completeness indicator
- Profile visibility settings (public/private)
- Profile customization (themes, backgrounds)
- Export user data (GDPR compliance)

---

## Change Log

| Date       | Version | Description            | Author           |
| ---------- | ------- | ---------------------- | ---------------- |
| 2026-01-01 | 1.0     | Initial story creation | Sarah (PO Agent) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

---

## QA Results

_This section will be populated by the QA Agent after story completion._
