# Test Design: Story 6.5 - Checkout Flow & Payment Experience

**Story:** 6.5  
**Component:** Stripe Checkout Integration  
**QA Engineer:** Quinn (Test Architect)  
**Date:** 2026-01-13  
**Risk Level:** HIGH (Payment flow - revenue critical)

---

## 1. Test Strategy

### Test Levels
- **Integration Tests** (40%): Checkout session creation API
- **E2E Tests** (60%): Complete payment flows with test cards

### Focus Areas
- Stripe Checkout session creation
- Payment with test cards (success/failure)
- Redirect handling
- Session timeout
- Error handling

---

## 2. Test Scenarios

### Scenario 1: Checkout Session Creation (P0)
**Given-When-Then:**
- **Given** authenticated user selects Pro tier
- **When** POST /api/checkout/create with tierId="pro"
- **Then** Stripe Checkout session created
- **And** returns checkoutUrl

**Test Cases:**
- TC-6.5-001: Valid tier → session created
- TC-6.5-002: Invalid tier → 400 error
- TC-6.5-003: Unauthenticated → 401 error
- TC-6.5-004: Already subscribed → 400 error
- TC-6.5-005: Stripe API error → 500 error

**Priority:** P0

---

### Scenario 2: Successful Payment (P0)
**Given-When-Then:**
- **Given** user in Stripe Checkout
- **When** enters card 4242 4242 4242 4242
- **Then** payment succeeds
- **And** redirects to /subscription/success

**Test Cards:**
- TC-6.5-010: Success card (4242...) → payment succeeds
- TC-6.5-011: 3D Secure card → auth flow works
- TC-6.5-012: Success → webhook triggered
- TC-6.5-013: Success → database updated

**Priority:** P0

---

### Scenario 3: Failed Payment (P0)
**Test Cases:**
- TC-6.5-020: Declined card (4000...0002) → error shown
- TC-6.5-021: Insufficient funds (4000...9995) → error shown
- TC-6.5-022: Expired card (4000...0069) → error shown
- TC-6.5-023: Error messages in Thai
- TC-6.5-024: Retry option available

**Priority:** P0

---

### Scenario 4: Session Timeout (P1)
**Test Cases:**
- TC-6.5-030: Session expires after 30 min
- TC-6.5-031: Expired session → redirect to pricing
- TC-6.5-032: Clear error message shown

**Priority:** P1

---

## 3. E2E Test Scenarios

### Scenario 5: Complete Checkout Flow (P0)
**Steps:**
1. Login
2. Go to pricing
3. Select tier
4. Redirected to Stripe Checkout
5. Enter test card
6. Complete payment
7. Redirected to success page
8. Verify subscription in profile

**Priority:** P0

---

## 4. Success Criteria

✅ **Checkout:**
- [ ] Session creation works
- [ ] Test cards work correctly
- [ ] Errors handled gracefully

**Estimated Effort:** 2-3 days
