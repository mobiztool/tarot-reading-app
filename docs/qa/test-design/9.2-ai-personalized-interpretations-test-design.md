# Test Design: Story 9.2 - AI Personalized Interpretations (VIP Feature)

**Story:** 9.2  
**Component:** AI-Powered Personalized Tarot Interpretations  
**QA Engineer:** Quinn (Test Architect)  
**Date:** 2026-01-13  
**Risk Level:** VERY HIGH (AI integration, cost, quality control)

---

## 1. Test Strategy

### Test Levels
- **Unit Tests** (30%): Prompt engineering, response parsing
- **Integration Tests** (40%): AI API, fallback logic, rate limiting
- **Manual QA** (20%): AI output quality review (50+ samples)
- **E2E Tests** (10%): User experience with AI

### Focus Areas
- **AI API integration** (Claude/OpenAI)
- **Output quality** (coherent, valuable, Thai language)
- **Fallback logic** (graceful degradation when AI fails)
- **Cost control** (rate limiting, caching, budget alerts)
- **VIP-only access**

---

## 2. Test Scenarios

### Scenario 1: AI API Integration (P0)
**Given-When-Then:**
- **Given** VIP user requests AI interpretation
- **When** calling AI service (e.g., Claude API)
- **Then** receives personalized response
- **And** API connection successful

**Test Cases:**
- TC-9.2-001: AI API configured correctly
- TC-9.2-002: API key environment variable set
- TC-9.2-003: API endpoint reachable
- TC-9.2-004: Request format correct (JSON)
- TC-9.2-005: Response parsed successfully
- TC-9.2-006: Thai language specified in prompt
- TC-9.2-007: Model version specified (e.g., claude-3-5-sonnet)

**Priority:** P0 (Foundation)

---

### Scenario 2: Prompt Engineering (P0)
**Given-When-Then:**
- **Given** tarot reading data (cards, positions, user question)
- **When** constructing AI prompt
- **Then** prompt includes:
  - Card names and meanings
  - Position contexts
  - User's question
  - Thai language instruction
  - Tarot interpretation guidelines

**Test Cases:**
- TC-9.2-010: Prompt includes all card details
- TC-9.2-011: Prompt includes position contexts
- TC-9.2-012: User question incorporated
- TC-9.2-013: Thai language explicitly requested
- TC-9.2-014: Tarot expertise instructions included
- TC-9.2-015: Prompt optimized for quality (tested manually)
- TC-9.2-016: Prompt length within API limits

**Priority:** P0 (Quality foundation)

---

### Scenario 3: AI Output Quality (P0)
**Given-When-Then:**
- **Given** AI-generated interpretation
- **When** reviewing output quality
- **Then** output is:
  - Coherent and well-structured
  - Tarot-accurate
  - Thai language natural
  - Personalized to user context
  - Actionable guidance provided

**Test Cases:**
- TC-9.2-020: AI output coherent (not gibberish)
- TC-9.2-021: Thai language natural (not machine-translated feel)
- TC-9.2-022: Tarot card meanings accurate
- TC-9.2-023: Personalized to user's question
- TC-9.2-024: Length appropriate (200-400 words)
- TC-9.2-025: Actionable advice included
- TC-9.2-026: No harmful/inappropriate content
- TC-9.2-027: Tone supportive and insightful
- TC-9.2-028: **Manual QA: 50+ samples reviewed**
- TC-9.2-029: Average quality rating >4.0/5

**Priority:** P0 (Premium VIP value)

---

### Scenario 4: Fallback Logic When AI Fails (P0)
**Given-When-Then:**
- **Given** AI API call fails
- **When** error occurs (timeout, API error, rate limit)
- **Then** gracefully falls back to standard interpretation
- **And** user sees seamless experience
- **And** error logged for monitoring

**Test Cases:**
- TC-9.2-030: API timeout (>10s) → fallback to standard
- TC-9.2-031: API error (500) → fallback to standard
- TC-9.2-032: Rate limit hit → fallback or queue
- TC-9.2-033: Invalid API response → fallback
- TC-9.2-034: Network error → fallback
- TC-9.2-035: User sees standard interpretation (no error shown)
- TC-9.2-036: Subtle indicator AI unavailable (optional)
- TC-9.2-037: Error logged to Sentry with context
- TC-9.2-038: Fallback success rate >99%

**Priority:** P0 (Reliability - cannot fail users)

---

### Scenario 5: Cost Control & Rate Limiting (P0)
**Given-When-Then:**
- **Given** AI calls cost money (~$0.01-0.05 per reading)
- **When** monitoring usage
- **Then** costs controlled within budget
- **And** abuse prevented

**Test Cases:**
- TC-9.2-040: Rate limit per VIP user (e.g., 10 AI readings/day)
- TC-9.2-041: Rate limit enforced (11th request → fallback or wait)
- TC-9.2-042: Cost tracking per request (logged)
- TC-9.2-043: Daily cost aggregation
- TC-9.2-044: Alert if daily cost >threshold (e.g., $100/day)
- TC-9.2-045: Monthly cost monitoring dashboard
- TC-9.2-046: Cache AI responses (same cards + question = same result)
- TC-9.2-047: Cache expiry reasonable (24 hours)

**Priority:** P0 (Cost management)

---

### Scenario 6: VIP-Only Access (P0)
**Given-When-Then:**
- **Given** AI interpretation feature
- **When** checking access
- **Then** only VIP users can use
- **And** Pro users see upgrade prompt

**Test Cases:**
- TC-9.2-050: FREE/BASIC/PRO users → feature locked
- TC-9.2-051: VIP users → can enable AI interpretation
- TC-9.2-052: Toggle button shows tier requirement
- TC-9.2-053: Upgrade prompt explains AI benefit
- TC-9.2-054: Feature clearly labeled "VIP Exclusive"

**Priority:** P0

---

### Scenario 7: AI Response Time & UX (P1)
**Given-When-Then:**
- **Given** VIP user enables AI
- **When** waiting for AI response
- **Then** loading indicator shown
- **And** response within acceptable time

**Test Cases:**
- TC-9.2-060: AI response time < 5 seconds (p95)
- TC-9.2-061: Loading indicator animated (not stuck)
- TC-9.2-062: User can cancel request
- TC-9.2-063: Timeout after 10 seconds → fallback
- TC-9.2-064: Progress indicator shows "Generating..."
- TC-9.2-065: Standard interpretation loads first, AI enhances

**Priority:** P1 (UX)

---

### Scenario 8: AI + Standard Interpretation Combination (P1)
**Given-When-Then:**
- **Given** AI interpretation generated
- **When** displaying to user
- **Then** combines with standard interpretation
- **Or** clearly separates sections

**Test Cases:**
- TC-9.2-070: Standard interpretation shown first
- TC-9.2-071: AI interpretation clearly labeled
- TC-9.2-072: Both sections readable
- TC-9.2-073: User can toggle AI on/off
- TC-9.2-074: Preference saved for future readings

**Priority:** P1

---

### Scenario 9: Content Safety & Moderation (P0)
**Given-When-Then:**
- **Given** AI can generate any content
- **When** monitoring outputs
- **Then** no harmful content generated
- **And** inappropriate outputs filtered

**Test Cases:**
- TC-9.2-080: AI prompt includes safety guidelines
- TC-9.2-081: Content moderation check (optional)
- TC-9.2-082: No offensive language in outputs
- TC-9.2-083: No harmful advice generated
- TC-9.2-084: Manual review of flagged outputs
- TC-9.2-085: User can report inappropriate AI content

**Priority:** P0 (User safety)

---

### Scenario 10: Thai Language Quality (P0)
**Given-When-Then:**
- **Given** AI generates Thai interpretation
- **When** reviewing language
- **Then** natural Thai expressions
- **And** not machine-translated feeling

**Test Cases:**
- TC-9.2-090: Thai grammar correct
- TC-9.2-091: Natural Thai expressions (not literal translations)
- TC-9.2-092: Appropriate formal/informal level
- TC-9.2-093: Thai tarot terminology correct
- TC-9.2-094: Cultural context appropriate
- TC-9.2-095: Native Thai speaker review (50+ samples)

**Priority:** P0 (Thai UX quality)

---

## 3. Integration Test Scenarios

### Scenario 11: API Endpoint Integration (P0)
**Test Cases:**
- TC-9.2-100: POST /api/ai/interpret endpoint works
- TC-9.2-101: VIP tier validated server-side
- TC-9.2-102: Rate limiting enforced
- TC-9.2-103: Request includes reading data
- TC-9.2-104: Response includes AI interpretation
- TC-9.2-105: Error handling returns fallback

**Priority:** P0

---

### Scenario 12: Caching Strategy (P1)
**Test Cases:**
- TC-9.2-110: Same reading cached (24h)
- TC-9.2-111: Cache key includes cards + question
- TC-9.2-112: Cache reduces AI API calls
- TC-9.2-113: Cache invalidation after 24h

**Priority:** P1

---

## 4. E2E Test Scenarios

### Scenario 13: Complete AI Interpretation Flow (P0)
**Steps:**
1. Login as VIP user
2. Start any reading (e.g., Celtic Cross)
3. Enter personal question
4. Draw cards
5. Toggle "AI Personalized Interpretation" ON
6. Wait for AI response (~3-5s)
7. View combined interpretation (standard + AI)
8. Verify AI content high quality
9. Save reading with AI interpretation
10. Reload from history → AI content preserved

**Priority:** P0

---

### Scenario 14: AI Failure Graceful Degradation (P0)
**Steps:**
1. Login as VIP
2. Start reading
3. Enable AI interpretation
4. Simulate AI API failure (network disconnect)
5. Verify fallback to standard interpretation
6. Verify no error shown to user
7. Verify can still complete reading

**Priority:** P0 (Reliability)

---

## 5. Test Data Requirements

### AI API Credentials
```javascript
{
  provider: "Claude" or "OpenAI",
  api_key: process.env.AI_API_KEY,
  model: "claude-3-5-sonnet-20241022",
  max_tokens: 800,
  temperature: 0.7
}
```

### Sample Readings for AI Testing
```javascript
{
  simple: { cards: 3, question: "วันนี้จะเป็นอย่างไร?" },
  complex: { cards: 10, question: "ทิศทางชีวิตของฉันในปีนี้?" },
  personal: { cards: 7, question: "ความรักของฉันจะเป็นอย่างไร?" },
}
```

---

## 6. Manual QA Requirements

### AI Output Review (50+ Samples)
- [ ] Sample 1-10: Simple 1-3 card readings
- [ ] Sample 11-30: Medium 5-7 card readings
- [ ] Sample 31-50: Complex 10+ card readings
- [ ] Review for:
  - Coherence ✓
  - Tarot accuracy ✓
  - Thai language quality ✓
  - Personalization ✓
  - Actionability ✓
  - Safety ✓

**Rating Scale:** 1-5 stars  
**Target:** Average >4.0/5

---

## 7. Cost Monitoring

### Budget Tracking
```yaml
Assumptions:
  AI cost per reading: $0.02-0.05
  VIP users: 100
  AI readings per user per month: 10
  Monthly AI cost: $20-500
  
Alert Thresholds:
  Daily cost >$50
  Weekly cost >$300
  Monthly cost >$1,000
```

---

## 8. Success Criteria

✅ **AI Integration:**
- [ ] API integration working reliably
- [ ] Fallback logic 100% reliable
- [ ] Cost within budget
- [ ] Rate limiting prevents abuse

✅ **Quality:**
- [ ] AI outputs >4.0/5 average rating
- [ ] Thai language natural
- [ ] Tarot-accurate
- [ ] Personalized and helpful

✅ **VIP Feature:**
- [ ] Only VIP can access
- [ ] Clear value proposition
- [ ] Drives VIP conversions

✅ **Monitoring:**
- [ ] Cost tracking dashboard
- [ ] Quality monitoring ongoing
- [ ] Error rates acceptable
- [ ] User satisfaction high

---

**Estimated Effort:** 1 week (5-7 days)

**Critical Success Factors:**
- AI output quality consistent
- Fallback never fails users
- Costs controlled

**Dependencies:**
- AI API account and credits
- Prompt engineering expertise
- Thai language QA reviewer
