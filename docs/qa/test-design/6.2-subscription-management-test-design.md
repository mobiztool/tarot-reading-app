# Test Design: Story 6.2 - Subscription Management System

**Story:** 6.2  
**Component:** Subscription Management  
**QA Engineer:** Quinn (Test Architect)  
**Date:** 2026-01-13  
**Risk Level:** HIGH (Business-critical subscription logic)

---

## 1. Test Strategy

### Test Levels
- **Unit Tests** (70%): Subscription helpers, tier configuration
- **Integration Tests** (20%): API routes, database sync
- **E2E Tests** (10%): Complete subscription flows

### Focus Areas
- Tier access control logic
- Quota enforcement (readings per day)
- Grace period handling
- Database sync with Stripe
- Subscription lifecycle state transitions

---

## 2. Test Scenarios

### Scenario 1: Get User Subscription (P0)
**Given-When-Then:**
- **Given** user has active Basic subscription
- **When** getUserSubscription() is called
- **Then** returns subscription with status "active"
- **And** includes tier, billing dates, status

**Test Cases:**
- TC-6.2-001: User with active subscription → returns subscription
- TC-6.2-002: User with no subscription → returns null
- TC-6.2-003: User with canceled subscription → returns null (not active)
- TC-6.2-004: User with trialing subscription → returns subscription
- TC-6.2-005: User with past_due subscription → returns subscription (grace period)

**Priority:** P0 (Critical for access control)

---

### Scenario 2: Tier Access Control (P0)
**Given-When-Then:**
- **Given** user is on Basic tier
- **When** canAccessSpread("celtic_cross") is called
- **Then** returns false (Pro/VIP only)
- **And** includes requiredTier in response

**Test Cases:**
- TC-6.2-010: Free tier → can access daily, three_card only
- TC-6.2-011: Basic tier → can access 5 spreads
- TC-6.2-012: Pro tier → can access 10 spreads
- TC-6.2-013: VIP tier → can access all 18 spreads
- TC-6.2-014: Guest user (no auth) → treated as FREE tier
- TC-6.2-015: Invalid spread type → returns false with error

**Priority:** P0 (Revenue protection)

---

### Scenario 3: Reading Quota Enforcement (P0)
**Given-When-Then:**
- **Given** Free user has created 3 readings today
- **When** canCreateReading() is called
- **Then** returns false
- **And** getRemainingReadingsToday() returns 0

**Test Cases:**
- TC-6.2-020: Free user at quota limit (3/3) → cannot create
- TC-6.2-021: Free user below limit (2/3) → can create
- TC-6.2-022: Basic user at any count → unlimited (-1)
- TC-6.2-023: Quota resets at midnight (UTC+7)
- TC-6.2-024: New user starts with full quota

**Priority:** P0 (Revenue driver for upgrades)

---

### Scenario 4: Grace Period Logic (P0)
**Given-When-Then:**
- **Given** user canceled subscription yesterday
- **When** isInGracePeriod() is called
- **And** current_period_end is in future
- **Then** returns true
- **And** user retains access

**Test Cases:**
- TC-6.2-030: Canceled but period not ended → in grace period
- TC-6.2-031: Canceled and period ended → not in grace period
- TC-6.2-032: Active subscription (not canceled) → not in grace period
- TC-6.2-033: Grace period access to premium features → allowed
- TC-6.2-034: After grace period expires → downgrade to FREE

**Priority:** P0 (Fair cancellation policy)

---

### Scenario 5: Subscription API - Get User Subscriptions (P1)
**Given-When-Then:**
- **Given** authenticated user with Pro subscription
- **When** GET /api/subscriptions
- **Then** returns 200 with subscriptions array
- **And** includes currentTier

**Test Cases:**
- TC-6.2-040: Authenticated request → returns subscriptions
- TC-6.2-041: Unauthenticated request → returns 401
- TC-6.2-042: User with multiple subscriptions → returns all, sorted by date
- TC-6.2-043: User with no subscriptions → returns empty array + FREE tier
- TC-6.2-044: Response includes stripe_price_id for tier derivation

**Priority:** P1

---

### Scenario 6: Subscription API - Create Subscription (P0)
**Given-When-Then:**
- **Given** authenticated user with no active subscription
- **When** POST /api/subscriptions with tierId="pro"
- **Then** creates Stripe Checkout session
- **And** returns checkoutUrl

**Test Cases:**
- TC-6.2-050: Valid tier selection → creates checkout session
- TC-6.2-051: Invalid tier → returns 400
- TC-6.2-052: User already has active subscription → returns 400
- TC-6.2-053: Missing Stripe price ID (env) → returns 400
- TC-6.2-054: Stripe API error → returns 500 with Thai error message

**Priority:** P0 (Revenue generation)

---

### Scenario 7: Tier from Price ID Mapping (P1)
**Given-When-Then:**
- **Given** subscription with stripe_price_id = STRIPE_PRICE_ID_PRO
- **When** getTierFromPriceId() is called
- **Then** returns "pro"

**Test Cases:**
- TC-6.2-060: Basic price ID → returns "basic"
- TC-6.2-061: Pro price ID → returns "pro"
- TC-6.2-062: VIP price ID → returns "vip"
- TC-6.2-063: Unknown price ID → returns "free"
- TC-6.2-064: Null price ID → returns "free"

**Priority:** P1

---

### Scenario 8: Tier Comparison Logic (P2)
**Given-When-Then:**
- **Given** comparing "pro" vs "basic"
- **When** compareTiers() is called
- **Then** returns positive number (pro > basic)
- **And** isHigherTier() returns true

**Test Cases:**
- TC-6.2-070: pro > basic → positive comparison
- TC-6.2-071: basic > free → positive comparison
- TC-6.2-072: vip > pro → positive comparison
- TC-6.2-073: Same tier → returns 0
- TC-6.2-074: Lower tier comparison → negative number

**Priority:** P2 (Utility function)

---

## 3. Integration Test Scenarios

### Scenario 9: Database Sync After Webhook (P0)
**Given-When-Then:**
- **Given** subscription.created webhook received
- **When** webhook handler processes event
- **Then** subscription saved to database
- **And** user.currentTier updated

**Test Cases:**
- TC-6.2-080: subscription.created → DB insert + user tier update
- TC-6.2-081: subscription.updated → DB update
- TC-6.2-082: subscription.deleted → status = "canceled", tier = FREE
- TC-6.2-083: Duplicate webhook → upsert prevents duplicates
- TC-6.2-084: Invalid userId in metadata → error logged, no DB changes

**Priority:** P0

---

### Scenario 10: Subscription Status Transitions (P0)
**Given-When-Then:**
- **Given** subscription in "trialing" status
- **When** trial ends and payment succeeds
- **Then** status changes to "active"
- **And** webhook syncs to database

**Test Cases:**
- TC-6.2-090: trialing → active (trial conversion)
- TC-6.2-091: active → past_due (payment failed)
- TC-6.2-092: past_due → active (retry succeeded)
- TC-6.2-093: past_due → unpaid (grace period expired)
- TC-6.2-094: active → canceled (user canceled)
- TC-6.2-095: paused → active (user resumed)

**Priority:** P0

---

## 4. E2E Test Scenarios

### Scenario 11: Complete Subscription Flow (P0)
**Steps:**
1. Login as free user
2. View profile → see FREE tier
3. Click upgrade → navigate to pricing
4. Select Basic tier → checkout
5. Complete payment (test card)
6. Verify success page
7. Return to profile → see Basic tier
8. Attempt premium spread → access granted

**Priority:** P0

---

### Scenario 12: Quota Enforcement Flow (P0)
**Steps:**
1. Login as free user
2. Create 3 daily readings
3. Attempt 4th reading → blocked with upgrade prompt
4. Upgrade to Basic
5. Create unlimited readings → all succeed

**Priority:** P0

---

## 5. Test Data Requirements

### Users
```javascript
{
  free_user: { tier: "free", readings_today: 0 },
  basic_user: { tier: "basic", subscription: "active" },
  pro_user: { tier: "pro", subscription: "active" },
  vip_user: { tier: "vip", subscription: "active" },
  trial_user: { tier: "pro", subscription: "trialing" },
  grace_user: { tier: "basic", subscription: "canceled", period_end: "2026-01-20" },
}
```

### Subscriptions
```javascript
{
  active_basic: { status: "active", tier: "basic", price_id: "price_basic" },
  trialing_pro: { status: "trialing", tier: "pro", trial_end: "2026-01-20" },
  canceled_basic: { status: "canceled", tier: "basic", cancel_at: "2026-01-15" },
}
```

---

## 6. Risk Coverage Matrix

| Risk | Severity | Test Coverage | Mitigation |
|------|----------|---------------|------------|
| Incorrect tier access | HIGH | TC-6.2-010-015 | P0 tests |
| Quota bypass | HIGH | TC-6.2-020-024 | P0 tests |
| Grace period violation | MEDIUM | TC-6.2-030-034 | P0 tests |
| Database sync failure | HIGH | TC-6.2-080-084 | Integration tests |
| Status transition bugs | MEDIUM | TC-6.2-090-095 | Integration tests |

---

## 7. Test Execution Plan

### Phase 1: Unit Tests (Day 1)
- Implement TC-6.2-001 to TC-6.2-074
- Target: >90% code coverage
- Tools: Vitest, mocked Prisma

### Phase 2: Integration Tests (Day 2)
- Implement TC-6.2-080 to TC-6.2-095
- Target: >85% coverage
- Tools: Vitest, test database

### Phase 3: E2E Tests (Day 3)
- Implement Scenarios 11-12
- Tools: Playwright, test Stripe account

### Phase 4: Regression Testing (Day 4)
- Run full test suite
- Verify coverage thresholds
- Fix failing tests

---

## 8. Success Criteria

✅ **Unit Tests:**
- [ ] All 40+ test cases pass
- [ ] Code coverage >90%
- [ ] No critical bugs found

✅ **Integration Tests:**
- [ ] Database sync verified
- [ ] Webhook idempotency tested
- [ ] Status transitions validated

✅ **E2E Tests:**
- [ ] Complete subscription flow works
- [ ] Quota enforcement verified
- [ ] Grace period access confirmed

✅ **Overall:**
- [ ] All P0 tests passing
- [ ] QA sign-off obtained
- [ ] Ready for production

---

**Next Steps:**
1. Review test design with team
2. Implement unit tests (helpers.ts, tiers.ts)
3. Implement integration tests (API routes, webhooks)
4. Implement E2E tests (subscription flows)
5. Run full test suite and generate coverage report

**Estimated Effort:** 4-5 days for complete test implementation
