# Test Design: Story 6.3 - Feature Gating by Subscription Tier

**Story:** 6.3  
**Component:** Access Control & Premium Gates  
**QA Engineer:** Quinn (Test Architect)  
**Date:** 2026-01-13  
**Risk Level:** HIGH (Revenue protection - prevents unauthorized access)

---

## 1. Test Strategy

### Test Levels
- **Unit Tests** (60%): Access control functions
- **Integration Tests** (30%): Premium gate components, API checks
- **E2E Tests** (10%): User flows with tier restrictions

### Critical Focus
- **Authorization logic** - prevent premium access without payment
- **Quota enforcement** - reading limits per tier
- **Premium gate UI** - conversion funnel to upgrade
- **Analytics tracking** - measure gate effectiveness

---

## 2. Test Scenarios

### Scenario 1: Spread Access Matrix Validation (P0)
**Given-When-Then:**
- **Given** SPREAD_ACCESS_MATRIX is defined
- **When** checking spread access for each tier
- **Then** correct spreads are accessible per tier

**Test Cases:**
- TC-6.3-001: FREE tier → 2 spreads only (daily, three_card)
- TC-6.3-002: BASIC tier → 5 spreads (FREE + love, career, yes_no)
- TC-6.3-003: PRO tier → 10 spreads (BASIC + 5 premium)
- TC-6.3-004: VIP tier → 18 spreads (all spreads with wildcard "*")
- TC-6.3-005: Matrix completeness → all 18 spreads defined
- TC-6.3-006: No overlap errors → spreads not in multiple exclusive groups

**Priority:** P0 (Foundation for access control)

---

### Scenario 2: canAccessSpread Function (P0)
**Given-When-Then:**
- **Given** user on BASIC tier
- **When** canAccessSpread(userId, "celtic_cross")
- **Then** returns { allowed: false, requiredTier: "pro", currentTier: "basic" }

**Test Cases:**
- TC-6.3-010: FREE user + free spread → allowed = true
- TC-6.3-011: FREE user + premium spread → allowed = false
- TC-6.3-012: BASIC user + basic spread → allowed = true
- TC-6.3-013: BASIC user + pro spread → allowed = false
- TC-6.3-014: PRO user + pro spread → allowed = true
- TC-6.3-015: VIP user + any spread → allowed = true
- TC-6.3-016: Guest (null userId) → treated as FREE tier
- TC-6.3-017: Invalid spread type → allowed = false with error

**Priority:** P0 (Revenue protection)

---

### Scenario 3: Reading Quota Enforcement (P0)
**Given-When-Then:**
- **Given** FREE user has 3 readings today (at limit)
- **When** attempting to create 4th reading
- **Then** request blocked
- **And** premium gate shown

**Test Cases:**
- TC-6.3-020: FREE at quota (3/3) → blocked
- TC-6.3-021: FREE below quota (2/3) → allowed
- TC-6.3-022: BASIC unlimited → always allowed
- TC-6.3-023: PRO unlimited → always allowed
- TC-6.3-024: VIP unlimited → always allowed
- TC-6.3-025: Quota resets at midnight (Thailand TZ: UTC+7)
- TC-6.3-026: Quota counts all reading types

**Priority:** P0 (Freemium conversion driver)

---

### Scenario 4: Grace Period Access (P0)
**Given-When-Then:**
- **Given** user canceled PRO subscription yesterday
- **When** checking access today
- **And** current_period_end is tomorrow
- **Then** still has PRO access (grace period)

**Test Cases:**
- TC-6.3-030: Canceled + in period → access granted
- TC-6.3-031: Canceled + period expired → access denied
- TC-6.3-032: cancel_at_period_end = true → access until end
- TC-6.3-033: Grace period for all premium features → allowed
- TC-6.3-034: After period ends → immediate downgrade to FREE

**Priority:** P0 (Fair cancellation policy)

---

### Scenario 5: Premium Gate Component (P1)
**Given-When-Then:**
- **Given** FREE user attempts PRO spread
- **When** premium gate is shown
- **Then** displays upgrade prompt with features comparison
- **And** shows "Available in Pro tier" badge
- **And** includes upgrade CTA button

**Test Cases:**
- TC-6.3-040: Gate shows correct required tier
- TC-6.3-041: Gate shows feature comparison
- TC-6.3-042: CTA button redirects to pricing page
- TC-6.3-043: Gate includes current tier vs required tier
- TC-6.3-044: Thai localization throughout
- TC-6.3-045: Mobile responsive layout

**Priority:** P1 (Conversion funnel)

---

### Scenario 6: Upgrade Flow from Gate (P0)
**Given-When-Then:**
- **Given** user clicks upgrade button on premium gate
- **When** redirected to pricing page
- **Then** correct tier is pre-selected
- **And** original spread context is preserved

**Test Cases:**
- TC-6.3-050: Upgrade from gate → pricing with tier pre-selected
- TC-6.3-051: Complete upgrade → return to original spread
- TC-6.3-052: Cancel upgrade → return to previous page
- TC-6.3-053: URL params preserve context (e.g., ?from=celtic_cross)
- TC-6.3-054: After upgrade → spread immediately accessible

**Priority:** P0 (Revenue generation)

---

### Scenario 7: Analytics Tracking (P1)
**Given-When-Then:**
- **Given** FREE user encounters premium gate
- **When** gate is shown
- **Then** analytics event "premium_gate_shown" tracked
- **And** includes spreadType, currentTier, requiredTier

**Test Cases:**
- TC-6.3-060: premium_gate_shown → tracked with context
- TC-6.3-061: upgrade_clicked → tracked with spreadType
- TC-6.3-062: upgraded_from_gate → tracked with conversion path
- TC-6.3-063: gate_dismissed → tracked with reason
- TC-6.3-064: All events include user_id and timestamp

**Priority:** P1 (Product analytics)

---

### Scenario 8: Locked Spread UI Indicators (P2)
**Given-When-Then:**
- **Given** FREE user viewing spread selection page
- **When** page loads
- **Then** premium spreads show lock icon + badge

**Test Cases:**
- TC-6.3-070: Lock icon visible on premium spreads
- TC-6.3-071: "Pro" or "VIP" badge shown
- TC-6.3-072: Clicking locked spread → shows premium gate
- TC-6.3-073: Hover shows tooltip with tier requirement
- TC-6.3-074: Free spreads have no lock icon

**Priority:** P2 (UX clarity)

---

## 3. Integration Test Scenarios

### Scenario 9: API Access Control Middleware (P0)
**Given-When-Then:**
- **Given** FREE user makes API call to create celtic_cross reading
- **When** API checks tier access
- **Then** returns 403 Forbidden
- **And** response includes requiredTier

**Test Cases:**
- TC-6.3-080: API blocks premium spread for FREE tier → 403
- TC-6.3-081: API allows free spread for FREE tier → 200
- TC-6.3-082: API allows all spreads for VIP → 200
- TC-6.3-083: Unauthenticated request → treated as FREE tier
- TC-6.3-084: Response includes upgrade_url in error

**Priority:** P0 (API security)

---

### Scenario 10: Database Tier Sync (P0)
**Given-When-Then:**
- **Given** user upgrades from FREE to PRO
- **When** subscription webhook processed
- **Then** database tier updated
- **And** access checks reflect new tier immediately

**Test Cases:**
- TC-6.3-090: Tier update after upgrade → immediate effect
- TC-6.3-091: Tier update after downgrade → immediate effect
- TC-6.3-092: Tier update after cancellation + grace period → delayed
- TC-6.3-093: Database and Stripe tier always synced
- TC-6.3-094: Cache invalidation after tier change

**Priority:** P0 (Data consistency)

---

## 4. E2E Test Scenarios

### Scenario 11: Complete Gate-to-Upgrade Flow (P0)
**Steps:**
1. Login as FREE user
2. Navigate to spread selection
3. See premium spreads with lock icons
4. Click "Celtic Cross" (PRO spread)
5. Premium gate appears
6. Click "Upgrade to Pro"
7. Redirected to pricing page
8. Complete checkout
9. Return to spreads
10. Celtic Cross now accessible

**Expected Result:** Smooth conversion funnel, no friction

**Priority:** P0

---

### Scenario 12: Quota Limit Enforcement (P0)
**Steps:**
1. Login as FREE user (0 readings today)
2. Create daily reading #1 → success
3. Create daily reading #2 → success
4. Create daily reading #3 → success
5. Attempt reading #4 → blocked
6. Premium gate shown with "Unlimited readings with Basic"
7. Upgrade to Basic
8. Create reading #4 → success (unlimited)

**Priority:** P0

---

### Scenario 13: Grace Period Verification (P0)
**Steps:**
1. Login as PRO user (canceled yesterday, period ends tomorrow)
2. Access PRO spread → allowed (grace period)
3. Check profile → shows "Will end on [date]"
4. Wait until period ends (or mock date)
5. Access PRO spread → blocked
6. Premium gate shown → "Resubscribe to Pro"

**Priority:** P0

---

## 5. Test Data Requirements

### Spread Access Matrix
```javascript
{
  daily: ["free", "basic", "pro", "vip"],
  three_card: ["free", "basic", "pro", "vip"],
  love_relationships: ["basic", "pro", "vip"],
  career_money: ["basic", "pro", "vip"],
  yes_no: ["basic", "pro", "vip"],
  celtic_cross: ["pro", "vip"],
  // ... 18 total spreads
}
```

### Test Users
```javascript
{
  free_user: { tier: "free", readings_today: 0 },
  free_at_limit: { tier: "free", readings_today: 3 },
  basic_user: { tier: "basic", subscription: "active" },
  pro_user: { tier: "pro", subscription: "active" },
  grace_user: { tier: "pro", cancel_at: "2026-01-20", period_end: "2026-01-20" },
}
```

---

## 6. Risk Coverage Matrix

| Risk | Severity | Test Coverage | Mitigation |
|------|----------|---------------|------------|
| Unauthorized premium access | CRITICAL | TC-6.3-010-017 | P0 unit tests |
| Quota bypass | HIGH | TC-6.3-020-026 | P0 tests + API middleware |
| Grace period bugs | MEDIUM | TC-6.3-030-034 | P0 tests |
| Conversion funnel broken | HIGH | Scenario 11 | E2E tests |
| Analytics not tracking | LOW | TC-6.3-060-064 | P1 tests |

---

## 7. Test Execution Plan

### Phase 1: Unit Tests (Day 1-2)
- Access control functions (canAccessSpread)
- Quota enforcement logic
- Grace period calculations
- Target: >90% coverage

### Phase 2: Integration Tests (Day 2-3)
- API middleware access checks
- Premium gate component rendering
- Analytics event tracking
- Target: >85% coverage

### Phase 3: E2E Tests (Day 3-4)
- Complete gate-to-upgrade flow
- Quota enforcement flow
- Grace period verification
- Target: All P0 scenarios pass

---

## 8. Success Criteria

✅ **Authorization:**
- [ ] All unauthorized access attempts blocked
- [ ] Grace period access works correctly
- [ ] Tier updates reflect immediately

✅ **Quota Enforcement:**
- [ ] FREE users limited to 3 readings/day
- [ ] Paid users have unlimited access
- [ ] Quota resets at midnight

✅ **Conversion Funnel:**
- [ ] Premium gate displays correctly
- [ ] Upgrade flow completes successfully
- [ ] Analytics tracks all events

✅ **Overall:**
- [ ] All P0 tests passing
- [ ] Zero unauthorized access in tests
- [ ] QA sign-off for production

---

**Estimated Effort:** 4 days for complete test implementation
